"use strict";(self.webpackChunkthreejs_editor_react=self.webpackChunkthreejs_editor_react||[]).push([[9623],{9623:(t,i,s)=>{s.r(i),s.d(i,{THStackPainter:()=>c});var n=s(9490),r=s(1597),a=s(6950),e=s(2848),o=s(1225),f=s(4861);const h=(0,n.BIT)(16);class c extends a.JW{constructor(t,i,s){super(t,i,s),this.firstpainter=null,this.painters=[]}cleanup(){this.getPadPainter()?.cleanPrimitives((t=>t===this.firstpainter||this.painters.indexOf(t)>=0)),delete this.firstpainter,delete this.painters,super.cleanup()}buildStack(t){if(!t.fHists)return!1;const i=t.fHists.arr.length;if(i<=0)return!1;const s=(0,n.create)(n.clTList);s.Add((0,n.clone)(t.fHists.arr[0]),t.fHists.opt[0]);for(let r=1;r<i;++r){const i=(0,n.clone)(t.fHists.arr[r]),a=t.fHists.opt[r],e=s.arr[r-1],o=i.fXaxis,f=e.fXaxis;let h=o.fNbins===f.fNbins&&o.fXmin===f.fXmin&&o.fXmax===f.fXmax;if(!h&&o.fNbins>0&&o.fNbins<f.fNbins&&o.fXmin===f.fXmin&&Math.abs((o.fXmax-o.fXmin)/o.fNbins-(f.fXmax-f.fXmin)/f.fNbins)<1e-4){const t=new Array(e.fNcells).fill(0);for(let s=1;s<=o.fNbins;++s)t[s]=i.fArray[s];i.fNcells=e.fNcells,Object.assign(o,f),i.fArray=t,h=!0}if(!h)return console.warn(`When drawing THStack, cannot sum-up histograms ${i.fName} and ${e.fName}`),s.Clear(),!1;for(let t=0;t<i.fArray.length;++t)i.fArray[t]+=e.fArray[t];s.Add(i,a)}return t.fStack=s,!0}getMinMax(t){const i=this.getObject(),s=this.getPadPainter().getRootPad(!0);let r=0,e=0;const o=(t,i)=>{const s={min:0,max:0};let r=!0,e=!0;if(t.fMinimum!==n.kNoZoom&&(s.min=t.fMinimum,r=!1),t.fMaximum!==n.kNoZoom&&(s.max=t.fMaximum,e=!1),!r&&!e)return s;let o=1,f=t.fXaxis.fNbins,h=1,c=1,m=!0;t.fXaxis.TestBit(a.rb.kAxisRange)&&(o=t.fXaxis.fFirst,f=t.fXaxis.fLast),0===t._typename.indexOf(n.clTH2)&&(c=t.fYaxis.fNbins,t.fYaxis.TestBit(a.rb.kAxisRange)&&(h=t.fYaxis.fFirst,c=t.fYaxis.fLast));for(let n=h;n<=c;++n)for(let a=o;a<=f;++a){const o=t.getBinContent(a,n),f=i?t.getBinError(t.getBin(a,n)):0;r&&(m||o-f<s.min)&&(s.min=o-f),e&&(m||o+f>s.max)&&(s.max=o+f),m=!1}return s};if(this.options.nostack)for(let n=0;n<i.fHists.arr.length;++n){const s=o(i.fHists.arr[n],t);0===n?(r=s.min,e=s.max):(r=Math.min(r,s.min),e=Math.max(e,s.max))}else r=o(i.fStack.arr[0],t).min,e=o(i.fStack.arr[i.fStack.arr.length-1],t).max;if(e*=1+n.gStyle.fHistTopMargin,i.fMaximum!==n.kNoZoom&&(e=i.fMaximum),i.fMinimum!==n.kNoZoom&&(r=i.fMinimum),s?.fLogv??(1===this.options.ndim?s?.fLogy:s?.fLogz)){e<=0&&(e=1),r<=0&&(r=1e-4*e);const t=1/(1+.5*Math.log10(e/r)),i=1+.2*Math.log10(e/r);r*=t,e*=i}else r<.9*e&&r!==i.fMinimum&&(r=0);i.fMaximum!==n.kNoZoom&&this.options.nostack&&(e=i.fMaximum),i.fMinimum!==n.kNoZoom&&this.options.nostack&&(r=i.fMinimum);const f={min:r,max:e,hopt:`hmin:${r};hmax:${e}`};return!this.options.nostack&&i.fHistogram?.TestBit(h)||(f.hopt+=";ignore_min_max"),f}getHistDrawOption(t,i){let s=i||t.fOption||this.options.hopt;return s.toUpperCase().indexOf(this.options.hopt)<0&&(s+=" "+this.options.hopt),this.options.draw_errors&&!s&&(s="E"),this.options.pads||(s+=" same nostat"+this.options.auto),s}async drawNextHisto(t,i){const s=this.getObject(),n=this.options.nostack?s.fHists:s.fStack,r=n?.arr?.length||0;if(t>=r)return this;const a=this.options.horder?t:r-t-1,e=this.options.nostack?`hists_${a}`:`stack_${a}`,o=n.arr[a],f=this.getHistDrawOption(o,n.opt[a]);if(i){const s=i.getSubPadPainter(t+1);if(!s)return this;const n=s.selectCurrentPad(s.this_pad_name);return this.hdraw_func(s.getDom(),o,f).then((r=>(r&&(r.setSecondaryId(this,e),this.painters.push(r)),s.selectCurrentPad(n),this.drawNextHisto(t+1,i))))}return a>0&&!this.options.nostack&&(o.$baseh=n.arr[a-1]),this.options.auto&&(o.$num_histos=r),this.hdraw_func(this.getDom(),o,f).then((s=>(s.setSecondaryId(this,e),this.painters.push(s),this.drawNextHisto(t+1,i))))}decodeOptions(t){this.options||(this.options={}),Object.assign(this.options,{ndim:1,nostack:!1,same:!1,horder:!0,has_errors:!1,draw_errors:!1,hopt:"",auto:""});const i=this.getObject(),s=i.fHistogram||(i.fHists?i.fHists.arr[0]:null)||(i.fStack?i.fStack.arr[0]:null),a=t=>{if(t.fSumw2&&t.fSumw2.length>0)for(let i=0;i<t.fSumw2.length;++i)if(t.fSumw2[i]>0)return!0;return!1};if(s&&0===s._typename.indexOf(n.clTH2)&&(this.options.ndim=2),2!==this.options.ndim||t||(t="lego1"),i.fHists&&!this.options.nostack)for(let n=0;n<i.fHists.arr.length;++n)this.options.has_errors=this.options.has_errors||a(i.fHists.arr[n]);this.options.nhist=i.fHists?.arr?.length??1;const e=new r.nC(t);this.options.nostack=e.check("NOSTACK"),e.check("STACK")&&(this.options.nostack=!1),this.options.same=e.check("SAME"),e.check("NOCLEAR"),["PFC","PLC","PMC"].forEach((t=>{e.check(t)&&(this.options.auto+=" "+t)})),this.options.pads=e.check("PADS"),this.options.pads&&(this.options.nostack=!0),this.options.hopt=e.remain();const o=e.check("LEGO");this.options.errors=e.check("E"),!this.options.nostack&&this.options.has_errors&&!o&&!e.check("HIST")&&this.options.hopt.indexOf("E")<0&&(this.options.draw_errors=!0),this.options.horder=this.options.nostack||o}createHistogram(t){const i=t.fHists,s=i?i.arr.length:0;if(!s){const i=(0,n.createHistogram)(n.clTH1I,100);return(0,n.setHistogramTitle)(i,t.fTitle),i.fBits|=n.kNoStats,i}const r=i.arr[0],a=(0,n.createHistogram)(1===this.options.ndim?n.clTH1I:n.clTH2I,r.fXaxis.fNbins,r.fYaxis.fNbins);a.fName="axis_hist",a.fBits|=n.kNoStats,Object.assign(a.fXaxis,r.fXaxis),2===this.options.ndim&&Object.assign(a.fYaxis,r.fYaxis);for(let n=1;n<s;++n){const t=i.arr[n];a.fXaxis.fLabels||(a.fXaxis.fXmin=Math.min(a.fXaxis.fXmin,t.fXaxis.fXmin),a.fXaxis.fXmax=Math.max(a.fXaxis.fXmax,t.fXaxis.fXmax)),2!==this.options.ndim||a.fYaxis.fLabels||(a.fYaxis.fXmin=Math.min(a.fYaxis.fXmin,t.fYaxis.fXmin),a.fYaxis.fXmax=Math.max(a.fYaxis.fXmax,t.fYaxis.fXmax))}return a.fTitle=t.fTitle,a}updateObject(t){if(!this.matchObjectType(t))return!1;const i=this.getObject();if(i.fHists=t.fHists,i.fStack=t.fStack,i.fTitle=t.fTitle,i.fMinimum=t.fMinimum,i.fMaximum=t.fMaximum,this.options.nostack||(this.options.nostack=!this.buildStack(i)),this.firstpainter){let s=t.fHistogram;s||(s=i.fHistogram=this.createHistogram(i));const n=this.getMinMax(this.options.errors||this.options.draw_errors);this.firstpainter.options.hmin=n.min,this.firstpainter.options.hmax=n.max,this.firstpainter._checked_zooming=!1,1===this.options.ndim?(this.firstpainter.ymin=n.min,this.firstpainter.ymax=n.max):(this.firstpainter.zmin=n.min,this.firstpainter.zmax=n.max),this.firstpainter.updateObject(s),this.firstpainter.options.ignore_min_max=this.options.nostack||!s.TestBit(h)}const s=this.options.nostack?i.fHists:i.fStack,n=s?.arr?.length??0;if(n!==this.painters.length)this.did_update=1,this.getPadPainter()?.cleanPrimitives((t=>this.painters.indexOf(t)>=0)),this.painters=[];else{this.did_update=2;for(let t=0;t<n;++t){const i=this.options.horder?t:n-t-1,r=s.arr[i];this.painters[t].updateObject(r,this.getHistDrawOption(r,s.opt[i]))}}return!0}redraw(t){if(!this.did_update)return;const i=1===this.did_update;delete this.did_update;return(this.firstpainter?this.firstpainter.redraw(t):Promise.resolve(this)).then((()=>{if(i)return this.drawNextHisto(0,this.options.pads?this.getPadPainter():null);const s=i=>i>=this.painters.length?this:this.painters[i].redraw(t).then((()=>s(i+1)));return s(0)}))}fillContextMenuItems(t){t.addchk(this.options.draw_errors,"Draw errors",(t=>{this.options.draw_errors=t;const i=this.getObject(),s=this.options.nostack?i.fHists:i.fStack,n=s?.arr?.length??0;for(let r=0;r<n;++r){const t=this.options.horder?r:n-r-1,i=s.arr[t];this.painters[r].decodeOptions(this.getHistDrawOption(i,s.opt[t]))}this.redrawPad()}),"Change draw erros in the stack")}static async draw(t,i,s){if(!i.fHists||!i.fHists.arr)return null;const n=new c(t,i,s);let r=null,a=!1;return(0,f.ensureTCanvas)(n,!1).then((()=>{if(n.decodeOptions(s),n.hdraw_func=1===n.options.ndim?e.TH1Painter.draw:o.TH2Painter.draw,n.options.pads)return r=n.getPadPainter(),r.doingDraw()&&r.pad?.fPrimitives&&r.pad.fPrimitives.arr.length>1&&0===r.pad.fPrimitives.arr.indexOf(i)?(a=!0,void console.log("special case with THStack with is already rendered - do nothing")):(r.cleanPrimitives((t=>t!==n)),r.divide(n.options.nhist));if(n.options.nostack||(n.options.nostack=!n.buildStack(i)),n.options.same||!i.fHists?.arr.length)return void n.addToPadPrimitives();!i.fHistogram&&(i.fHistogram=n.createHistogram(i));const f=n.getMinMax(n.options.errors||n.options.draw_errors),h=n.options.hopt+";"+f.hopt;return n.hdraw_func(t,i.fHistogram,h).then((t=>{n.addToPadPrimitives(),n.firstpainter=t,t.setSecondaryId(n,"hist")}))})).then((()=>a?n:n.drawNextHisto(0,r)))}}}}]);
//# sourceMappingURL=9623.c333f9db.chunk.js.map