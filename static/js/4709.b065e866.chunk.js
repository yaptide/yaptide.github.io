/*! For license information please see 4709.b065e866.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkthreejs_editor_react=self.webpackChunkthreejs_editor_react||[]).push([[4709],{7243:(t,e,s)=>{s.d(e,{D:()=>h});var i=s(9490),a=s(6476),n=s(6950);class h extends n.JW{constructor(t,e,s,i){super(t,e,s),this.csstype=i}v7EvalAttr(t,e){const s=this.getObject();if(!s)return e;this.cssprefix&&(t=this.cssprefix+t);const i=t=>{if(void 0===e)return t;const s=typeof e,i=typeof t;return s===i?t:"boolean"===s?"string"===i?""!==t&&"0"!==t&&"no"!==t&&"off"!==t:!!t:"number"===s&&"string"===i?parseFloat(t):t};if(s.fAttr?.m){const e=s.fAttr.m[t];if(e)return i(e.v)}if(this.rstyle?.fBlocks){const e=this.rstyle.fBlocks;for(let a=0;a<e.length;++a){const n=e[a];if((this.csstype&&n.selector===this.csstype||s.fId&&n.selector==="#"+s.fId||s.fCssClass&&n.selector==="."+s.fCssClass)&&n.map?.m){const e=n.map.m[t.toLowerCase()];if(e)return i(e.v)}}}return e}v7SetAttr(t,e){const s=this.getObject();this.cssprefix&&(t=this.cssprefix+t),s?.fAttr?.m&&(s.fAttr.m[t]={v:e})}v7EvalLength(t,e,s){e<=0&&(e=1);const i=this.v7EvalAttr(t);if(void 0===i)return Math.round(s*e);if("number"===typeof i)return Math.round(i*e);if(null===i)return 0;let a=0,n=0,h=i,r=0,o=0;for(;h;){for(;o<h.length&&(" "===h[o]||"\t"===h[o]);)++o;if(o>=h.length)break;if("-"===h[o]||"+"===h[o]){if(r)return console.log("Fail to parse RPadLength "+i),s;r="-"===h[o]?-1:1,o++;continue}for(o>0&&(h=h.slice(o),o=0);o<h.length&&(h[o]>="0"&&h[o]<="9"||"."===h[o]);)o++;const t=parseFloat(h.slice(0,o));if(!Number.isFinite(t))return console.log(`Fail to parse RPadLength ${i}`),Math.round(s*e);h=h.slice(o),o=0,r||(r=1),h&&"%"===h[0]?(h=h.slice(1),a+=r*t*.01):h.length>1&&"p"===h[0]&&"x"===h[1]?(h=h.slice(2),n+=r*t):a+=r*t,r=0}return Math.round(a*e+n)}v7EvalColor(t,e){let s=this.v7EvalAttr(t,"");if(!s||!(0,i.isStr)(s))return e;if("auto"===s){const e=this.getPadPainter();if(void 0!==e?._auto_color_cnt){const i=e.getHistPalette(),a=e._auto_color_cnt++;let n=e._num_primitives-1;n<2&&(n=2),s=i?i.getColorOrdinal(a%n/n):"blue",this._auto_colors||(this._auto_colors={}),this._auto_colors[t]=s}else this._auto_colors&&this._auto_colors[t]?s=this._auto_colors[t]:(console.error(`Autocolor ${t} not defined yet - please check code`),s="")}else if("["===s[0]){const t=parseFloat(s.slice(1,s.length-1));if(s="black",Number.isFinite(t)){const e=this.getPadPainter()?.getHistPalette();e&&(s=e.getColorOrdinal(t))}}return s}v7EvalFont(t,e,s){e?"number"===typeof e&&(e={size:e}):e={};const n=this.getPadPainter(),h=n?._dfltRFont||{fFamily:"Arial",fStyle:"",fWeight:""},r=this.v7EvalAttr(t+"_angle",0),o=this.v7EvalAttr(t+"_align",e.align||"none"),l=this.v7EvalColor(t+"_color",e.color||"none"),d=this.v7EvalAttr(t+"_font_family",h.fFamily||"Arial"),c=this.v7EvalAttr(t+"_font_style",h.fStyle||""),g=this.v7EvalAttr(t+"_font_weight",h.fWeight||"");let m=this.v7EvalAttr(t+"_size",e.size||12);(0,i.isStr)(m)&&(m=parseFloat(m)),(!Number.isFinite(m)||m<=0)&&(m=12),s||(s=n?.getPadHeight()||100);const u=new a.qg(null,m,s);return u.setNameStyleWeight(d,c,g),r&&u.setAngle(360-r),"none"!==o&&u.setAlign(o),"none"!==l&&u.setColor(l),u}createv7AttFill(t){t&&(0,i.isStr)(t)||(t="fill_");const e=this.v7EvalColor(t+"color",""),s=this.v7EvalAttr(t+"style",0);this.createAttFill({pattern:s,color:e,color_as_svg:!0})}createv7AttLine(t){t&&(0,i.isStr)(t)||(t="line_");const e=this.v7EvalColor(t+"color","black"),s=this.v7EvalAttr(t+"width",1),a=this.v7EvalAttr(t+"style",1),n=this.v7EvalAttr(t+"pattern");this.createAttLine({color:e,width:s,style:a,pattern:n}),"border_"===t&&this.lineatt.setBorder(this.v7EvalAttr(t+"rx",0),this.v7EvalAttr(t+"ry",0))}createv7AttMarker(t){t&&(0,i.isStr)(t)||(t="marker_");const e=this.v7EvalColor(t+"color","black"),s=this.v7EvalAttr(t+"size",.01),a=this.v7EvalAttr(t+"style",1),n=s>=1?1:this.getPadPainter()?.getPadHeight()||100;this.createAttMarker({color:e,size:s,style:a,refsize:n})}v7AttrChange(t,e,s,a){if(!this.snapid)return!1;t._typename||(t._typename=`${i.nsREX}RChangeAttrRequest`,t.ids=[],t.names=[],t.values=[],t.update=!0),this.cssprefix&&(e=this.cssprefix+e),t.ids.push(this.snapid),t.names.push(e);let n=null;if(null!==s&&void 0!==s||(a||(a="none"),"none"!==a&&console.error(`Trying to set ${a} for none value`)),!a)switch(typeof s){case"number":a="double";break;case"boolean":a="boolean"}switch(n={_typename:`${i.nsREX}RAttrMap::`},a){case"none":n._typename+="NoValue_t";break;case"boolean":n._typename+="BoolValue_t",n.v=!!s;break;case"int":n._typename+="IntValue_t",n.v=parseInt(s);break;case"double":n._typename+="DoubleValue_t",n.v=parseFloat(s);break;default:n._typename+="StringValue_t",n.v=(0,i.isStr)(s)?s:JSON.stringify(s)}return t.values.push(n),!0}v7SendAttrChanges(t,e){const s=this.getCanvPainter();s&&t?._typename&&(void 0!==e&&(t.update=!!e),s.v7SubmitRequest("",t))}v7SubmitRequest(t,e,s){const a=this.getCanvPainter();return(0,i.isFunc)(a?.submitDrawableRequest)?this.snapid?a.submitDrawableRequest(t,e,this,s):(this._pending_request={kind:t,req:e,method:s},e):null}assignSnapId(t){if(this.snapid=t,this.snapid&&this._pending_request){const t=this._pending_request;this.v7SubmitRequest(t.kind,t.req,t.method),delete this._pending_request}}v7CommMode(){const t=this.getCanvPainter();return t&&t.submitDrawableRequest&&t._websocket?1:3}v7NormalMode(){return 1===this.v7CommMode()}v7OfflineMode(){return 3===this.v7CommMode()}}},8094:(t,e,s)=>{s.d(e,{R:()=>c});var i=s(9490),a=s(8260),n=s(1597),h=s(1488),r=s(3558),o=s(7124),l=s(6950),d=s(7243);class c extends d.D{constructor(t,e,s,i){super(t,i?e.getObject():e,"",i?e.csstype:"axis"),Object.assign(this,h.fm),this.initAxisPainter(),this.axis=s,i?(this.embedded=!0,this.cssprefix=i,this.rstyle=e.rstyle):this.cssprefix="axis_"}cleanup(){delete this.axis,delete this.axis_g,this.cleanupAxisPainter(),super.cleanup()}getAxisType(){return"RAttrAxis"}configureZAxis(t,e){this.name=t,this.kind=l.UV,this.log=!1;const s=this.v7EvalAttr("log",0);s&&(this.log=!0,this.logbase=10,Math.abs(s-Math.exp(1))<.1?this.logbase=Math.exp(1):s>1.9&&(this.logbase=Math.round(s))),e.logz=this.log}configureAxis(t,e,s,i,n,r,o,d,c){c||(c={}),this.name=t,this.full_min=e,this.full_max=s,this.kind=l.UV,this.vertical=r,this.log=!1;const g=this.v7EvalAttr("log",0),m=this.v7EvalAttr("symlog",0);if(this.reverse=c.reverse||!1,this.v7EvalAttr("time")){this.kind=l.Yu,this.timeoffset=0;let t=this.v7EvalAttr("timeOffset");void 0!==t&&(t=parseFloat(t),Number.isFinite(t)&&(this.timeoffset=1e3*t))}else this.axis?.fLabelsIndex?(this.kind=l.ei,delete this.own_labels):c.labels?this.kind=l.ei:this.kind=l.UV;this.kind===l.Yu?this.func=(0,a.w7)().domain([this.convertDate(i),this.convertDate(n)]):m&&m>0?(this.symlog=m,this.func=(0,a.aX)().constant(m).domain([i,n])):g?(n<=0&&(n=1),(i<=0||i>=n)&&(i=1e-4*n),this.log=!0,this.logbase=10,Math.abs(g-Math.exp(1))<.1?this.logbase=Math.exp(1):g>1.9&&(this.logbase=Math.round(g)),this.func=(0,a.ZE)().base(this.logbase).domain([i,n])):this.func=(0,a.m4)().domain([i,n]),this.scale_min=i,this.scale_max=n,this.gr_range=d||1e3;const u=o??[0,this.gr_range];this.axis_shift=u[1]-this.gr_range,this.reverse?this.func.range([u[1],u[0]]):this.func.range(u),this.kind===l.Yu?this.gr=t=>this.func(this.convertDate(t)):this.log?this.gr=t=>t<this.scale_min?this.vertical?this.func.range()[0]+5:-5:this.func(t):this.gr=this.func,delete this.format;const _=this.v7EvalAttr("ndiv",508);this.nticks=_%100,this.nticks2=(_%1e4-this.nticks)/100,this.nticks3=Math.floor(_/1e4),this.nticks>20&&(this.nticks=20);const f=Math.abs(this.gr_range)||100;if(this.kind===l.Yu){this.nticks>8&&(this.nticks=8);const t=this.scale_max-this.scale_min,e=(0,h.iF)(t/f,!1);let s=this.v7EvalAttr("timeFormat","");(!s||t<.1*(this.full_max-this.full_min))&&(s=(0,h.iF)(t/this.nticks,!0)),this.tfunc1=this.tfunc2=(0,a.DC)(s),e!==s&&(this.tfunc2=(0,a.DC)(e)),this.format=this.formatTime}else if(this.log)this.nticks2>1&&(this.nticks*=this.nticks2,this.nticks2=1),this.noexp=this.v7EvalAttr("noexp",!1),this.scale_max<300&&this.scale_min>.3&&10===this.logbase&&(this.noexp=!0),this.moreloglabels=this.v7EvalAttr("moreloglbls",!1),this.format=this.formatLog;else if(this.kind===l.ei){this.nticks=50;const t=this.scale_max-this.scale_min;this.nticks>t&&(this.nticks=Math.round(t)),this.nticks2=1,this.format=this.formatLabels}else this.order=0,this.ndig=0,this.format=this.formatNormal}getScaleMin(){return this.func?this.func.domain()[0]:0}getScaleMax(){return this.func?this.func.domain()[1]:0}formatLabels(t){const e=Math.round(t);if(this.axis?.fLabelsIndex){if(e<0||e>=this.axis.fNBinsNoOver)return null;for(let t=0;t<this.axis.fLabelsIndex.length;++t){const s=this.axis.fLabelsIndex[t];if(s.second===e)return s.first}}else{const t=this.getObject().fLabels;if(t&&e>=0&&e<t.length)return t[e]}return null}createTicks(t,e,s,i){s&&this.nticks&&this.kind===l.UV&&(this.noticksopt=!0);const a=this.produceTicks(this.nticks),n={nminor:0,nmiddle:0,nmajor:0,func:this.func,minor:a,middle:a,major:a};if(t){const t=n.major,e=1e-5*(this.scale_max-this.scale_min);return t[0]>this.scale_min+e&&t.unshift(this.scale_min),t[t.length-1]<this.scale_max-e&&t.push(this.scale_max),t}if(this.nticks2>1&&(!this.log||10===this.logbase)){n.minor=n.middle=this.produceTicks(n.major.length,this.nticks2);const t=Math.abs(this.func.range()[1]-this.func.range()[0]);n.middle.length<=n.major.length||n.middle.length>t/3.5?n.minor=n.middle=n.major:this.nticks3>1&&!this.log&&(n.minor=this.produceTicks(n.middle.length,this.nticks3),(n.minor.length<=n.middle.length||n.minor.length>t/1.7)&&(n.minor=n.middle))}if(n.reset=function(){this.nminor=this.nmiddle=this.nmajor=0},n.next=function(t){return!(this.nminor>=this.minor.length)&&(this.tick=this.minor[this.nminor++],this.grpos=this.func(this.tick),t&&(this.grpos=Math.round(this.grpos)),this.kind=3,this.nmiddle<this.middle.length&&Math.abs(this.grpos-this.func(this.middle[this.nmiddle]))<1&&(this.nmiddle++,this.kind=2),this.nmajor<this.major.length&&Math.abs(this.grpos-this.func(this.major[this.nmajor]))<1&&(this.nmajor++,this.kind=1),!0)},n.last_major=function(){return 1===this.kind&&this.nmajor===this.major.length},n.next_major_grpos=function(){return this.nmajor>=this.major.length?null:this.func(this.major[this.nmajor])},n.get_modifier=function(){return null},this.order=0,this.ndig=0,this.kind===l.UV&&!this.log&&n.major.length>0){let t=0,s=0,a=!1;if(!e){const e=Math.max(Math.abs(n.major[0]),Math.abs(n.major[n.major.length-1])),i=Math.min(Math.abs(n.major[0]),Math.abs(n.major[n.major.length-1])),h=e>0?3*Math.round(Math.log10(e)/3):0,r=i>0?3*Math.round(Math.log10(i)/3):0;a=e<2e4,(e||i)&&(t=Math.max(h,r)+3,s=Math.min(h,r)-3)}let h=0,r=this.ndig,o=1e10;for(let e=s;e<=t;e+=3){if(a&&3===e)continue;this.order=e,this.ndig=0;let t=[],s=0,i=0;for(;s<n.major.length;){const e=this.format(n.major[s],!0);if(t.indexOf(e)<0)t.push(e),i+=e.length,s++;else{if(++this.ndig>11)break;t=[],s=0,i=0}}!e&&this.ndig<4&&(i-=2*n.major.length+3),i<o&&(o=i,h=this.order,r=this.ndig)}this.order=h,this.ndig=r,i&&(this.order&&console.warn(`Axis painter - integer labels are configured, but axis order ${this.order} is preferable`),this.ndig&&console.warn(`Axis painter - integer labels are configured, but ${this.ndig} decimal digits are required`),this.ndig=0,this.order=0)}return n}isCenteredLabels(){return this.kind===l.ei||"log"!==this.kind&&this.v7EvalAttr("labels_center",!1)}processLabelsMove(t,e){if(this.optionUnlab||!this.axis_g)return!1;const s=this.axis_g.select(".axis_labels");if(!s||1!==s.size())return!1;if("start"===t){const t=s.node().getBBox();return s.append("rect").classed("drag",!0).attr("x",t.x).attr("y",t.y).attr("width",t.width).attr("height",t.height).style("cursor","move").call(n.Ru,!0),this.vertical?this.drag_pos0=e[0]:this.drag_pos0=e[1],!0}let i=s.property("fix_offset");if(this.vertical?(i+=Math.round(e[0]-this.drag_pos0),s.attr("transform",`translate(${i})`)):(i+=Math.round(e[1]-this.drag_pos0),s.attr("transform",`translate(0,${i})`)),i||s.attr("transform",null),"stop"===t&&(s.select("rect.drag").remove(),delete this.drag_pos0,i!==s.property("fix_offset"))){s.property("fix_offset",i);const t=s.property("side")||1;this.labelsOffset=i/(this.vertical?-t:t),this.changeAxisAttr(1,"labels_offset",this.labelsOffset/this.scalingSize)}return!0}addTitleDrag(t,e){if(!i.settings.MoveResize||this.isBatchMode())return;let s,h,r,o,l,d,c=null;const g=(0,a.$E)().subject(Object);g.on("start",(e=>{e.sourceEvent.preventDefault(),e.sourceEvent.stopPropagation();const i=t.node().getBBox(),a=this.vertical?i.height:i.width;r=s=t.property("shift_x"),o=h=t.property("shift_y"),d="center"===this.titlePos?1:"left"===this.titlePos?0:2,l=[0,this.gr_range/2,this.gr_range];const g=this.vertical?-a:a,m=this.isReverseAxis()?2:0;"middle"===this.title_align?(l[m]+=g/2,l[2-m]-=g/2):"begin"===this.title_align^this.isTitleRotated()?(l[1]-=g/2,l[2-m]-=g):(l[m]+=g,l[1]+=g/2),l[d]=this.vertical?h:s,c=t.append("rect").attr("x",i.x).attr("y",i.y).attr("width",i.width).attr("height",i.height).style("cursor","move").call(n.Ru,!0)})).on("drag",(e=>{if(!c)return;e.sourceEvent.preventDefault(),e.sourceEvent.stopPropagation(),s+=e.dx,h+=e.dy;const i=this.vertical?h:s;let a,g,m=0;for(let t=1;t<3;++t)Math.abs(i-l[t])<Math.abs(i-l[m])&&(m=t);this.vertical?(a=s,g=l[m]):(a=l[m],g=h),r=a,o=g,d=m,(0,n.bk)(t,r,o)})).on("end",(s=>{if(!c)return;s.sourceEvent.preventDefault(),s.sourceEvent.stopPropagation();const i=t.property("basepos")||0;t.property("shift_x",r).property("shift_y",o),this.titleOffset=(this.vertical?i-r:o-i)*e,this.titlePos=1===d?"center":0===d?"left":"right",this.changeAxisAttr(0,"title_position",this.titlePos,"title_offset",this.titleOffset/this.scalingSize),c.remove(),c=null})),t.style("cursor","move").call(g)}isInsideGrRange(t,e,s){return e||(e=0),void 0===s&&(s=e),this.gr_range<0?t>=this.gr_range-s&&t<=e:t>=-e&&t<=this.gr_range+s}getGrRange(t){return t||(t=0),this.gr_range<0?this.gr_range-t:this.gr_range+t}isReverseAxis(){return!this.vertical!==this.getGrRange()>0}drawMainLine(t){let e="";if(this.endingSize&&this.endingStyle){let t=this.gr_range>0?-this.endingSize:this.endingSize;const s=Math.round(.7*t);t=Math.round(t),e=this.vertical?`l${s},${t}M0,${this.gr_range}l${-s},${t}`:`l${t},${s}M${this.gr_range},0l${t},${-s}`}t.append("svg:path").attr("d","M0,0"+(this.vertical?"v":"h")+this.gr_range+e).call(this.lineatt.func).style("fill",e?"none":null)}drawTicks(t,e,s){s&&(this.ticks=[]),this.handle.reset();let i="",a=0;for("both"===this.ticksSide&&(e=1,a=1);this.handle.next(!0);){let t=Math.round(this.ticksSize/4),n=0;this.handle.kind<3&&(t=Math.round(this.ticksSize/2));const h=this.handle.grpos-this.axis_shift;(!this.startingSize&&!this.endingSize||this.isInsideGrRange(h,-Math.abs(this.startingSize),-Math.abs(this.endingSize)))&&(1===this.handle.kind&&(this.kind!==l.ei&&null===this.format(this.handle.tick,!0)||(t=this.ticksSize),s&&this.ticks.push(h)),a>0?n=-t:e<0?(n=-t,t=0):n=0,i+=this.vertical?`M${t},${h}H${n}`:`M${h},${-t}V${-n}`)}i&&t.append("svg:path").attr("d",i).style("stroke",this.ticksColor||this.lineatt.color).style("stroke-width",this.ticksWidth&&1!==this.ticksWidth?this.ticksWidth:null);const n=Math.round(.25*this.ticksSize),h=Math.round(1.25*this.ticksSize);return{"-1":e>0||a?h:n,1:e<0||a?h:n}}async drawLabels(t,e,s){const i=this.isCenteredLabels(),n=0!==this.labelsFont.angle,h=t.append("svg:g").attr("class","axis_labels").property("side",e),r=this.handle.lbl_pos||this.handle.major;let o=1,l=0,d=!1,c=0,g=0;function m(t){c=Math.max(c,this.result_width),g=Math.max(g,this.result_height);const s=this.result_width;if(s&&(!t.vertical&&!n||t.vertical&&n)&&!t.log){let t=.45*this.gap_before+.45*this.gap_after;this.gap_before?this.gap_after||(t=.9*this.gap_before):t=.9*this.gap_after,o=Math.min(o,t/s)}o>1e-4&&o<.8&&!t.vertical&&!n&&l>5&&e>0&&(d=!0);const i=o*(d?3:1);i>1e-4&&i<1&&t.scaleTextDrawing(1/i,h)}const u=Math.round((this.vertical?-e:e)*this.labelsOffset),_=Math.round((this.vertical?-e:e)*s[e]);let f=0;u&&h.attr("transform",this.vertical?`translate(${u})`:`translate(0,${u})`),h.property("fix_offset",u),this.startTextDrawing(this.labelsFont,"font",h);for(let a=0;a<r.length;++a){const t=this.format(r[a],!0);if(null===t)continue;const s={text:t,latex:1,draw_g:h};let d=Math.round(this.func(r[a]));if(s.gap_before=a>0?Math.abs(Math.round(d-this.func(r[a-1]))):0,s.gap_after=a<r.length-1?Math.abs(Math.round(this.func(r[a+1])-d)):0,i){const t=s.gap_after||s.gap_before;if(d=Math.round(d-(this.vertical?.5*t:-.5*t)),!this.isInsideGrRange(d,5))continue}if(l=Math.max(l,t.length),d-=this.axis_shift,!this.startingSize&&!this.endingSize||this.isInsideGrRange(d,-Math.abs(this.startingSize),-Math.abs(this.endingSize))){if(this.vertical?(s.x=_,s.y=d,s.align=n?e<0?23:20:e<0?12:32):(s.x=d,s.y=_,s.align=n?e<0?12:32:e<0?20:23,!this.log||this.noexp||this.vertical||23!==s.align||(s.align=21,s.y+=this.labelsFont.size)),s.post_process=m,this.drawText(s),f&&d!==f&&(this.vertical&&!n||!this.vertical&&n)){const t=Math.abs(d-f);o=Math.min(o,.9*t/this.labelsFont.size)}f=d}}return this.order&&this.drawText({x:this.vertical?5*e:this.getGrRange(5),y:this.has_obstacle?_:this.vertical?this.getGrRange(3):-3*e,align:this.vertical?e<0?30:10:this.has_obstacle^e<0?13:10,latex:1,text:"#times"+this.formatExp(10,this.order),draw_g:h}),this.finishTextDrawing(h).then((()=>{if(d&&h.selectAll("text").each((function(){const t=(0,a.Lt)(this),e=t.attr("transform");t.attr("transform",e+" rotate(25)").style("text-anchor","start")})),this.vertical)s[e]+=Math.round(n?1.2*g:c+.4*this.labelsFont.size)-e*u;else{const t=d?c*Math.sin(25/180*Math.PI)+g*(Math.cos(25/180*Math.PI)+.2):0;s[e]+=Math.round(Math.max(n?c+.4*this.labelsFont.size:1.2*g,1.2*this.labelsFont.size,t))+u}return s}))}addZoomingRect(t,e,s){if(i.settings.Zooming&&!this.disable_zooming&&!this.isBatchMode()){const i=Math.max(s[e],10),a=this.vertical?`v${this.gr_range}h${-e*i}v${-this.gr_range}`:`h${this.gr_range}v${e*i}h${-this.gr_range}`;t.append("svg:path").attr("d",`M0,0${a}z`).attr("class","axis_zoom").style("opacity","0").style("cursor","crosshair")}}isTitleRotated(){return this.titleFont&&this.titleFont.angle!==(this.vertical?270:0)}async drawTitle(t,e,s){if(!this.fTitle)return this;const i=t.append("svg:g").attr("class","axis_title"),a=this.isTitleRotated();let h=0,r=0,o=0;return this.startTextDrawing(this.titleFont,"font",i),this.title_align=this.titleCenter?"middle":this.titleOpposite^(this.isReverseAxis()||a)?"begin":"end",this.vertical?(o=Math.round(-e*s[e]),h=o+Math.round(-e*this.titleOffset),r=Math.round(this.titleCenter?this.gr_range/2:this.titleOpposite?0:this.gr_range),this.drawText({align:[this.title_align,e<0^a?"top":"bottom"],text:this.fTitle,draw_g:i})):(h=Math.round(this.titleCenter?this.gr_range/2:this.titleOpposite?0:this.gr_range),o=Math.round(e*s[e]),r=o+Math.round(e*this.titleOffset),this.drawText({align:[this.title_align,e>0^a?"top":"bottom"],text:this.fTitle,draw_g:i})),(0,n.bk)(i,h,r).property("basepos",o).property("shift_x",h).property("shift_y",r),this.addTitleDrag(i,e),this.finishTextDrawing(i)}extractDrawAttributes(t){const e=this.getPadPainter(),s=e?.getPadRect()||{width:10,height:10};this.scalingSize=t||(this.vertical?s.width:s.height),this.createv7AttLine("line_"),this.optionUnlab=this.v7EvalAttr("labels_hide",!1),this.endingStyle=this.v7EvalAttr("ending_style",""),this.endingSize=Math.round(this.v7EvalLength("ending_size",this.scalingSize,this.endingStyle?.02:0)),this.startingSize=Math.round(this.v7EvalLength("starting_size",this.scalingSize,0)),this.ticksSize=this.v7EvalLength("ticks_size",this.scalingSize,.02),this.ticksSide=this.v7EvalAttr("ticks_side","normal"),this.ticksColor=this.v7EvalColor("ticks_color",""),this.ticksWidth=this.v7EvalAttr("ticks_width",1),t&&this.ticksSize<0&&(this.ticksSize=-this.ticksSize),this.fTitle=this.v7EvalAttr("title_value",""),this.fTitle?(this.titleFont=this.v7EvalFont("title",{size:.03},t||e?.getPadHeight()||10),this.titleFont.roundAngle(180,this.vertical?270:0),this.titleOffset=this.v7EvalLength("title_offset",this.scalingSize,0),this.titlePos=this.v7EvalAttr("title_position","right"),this.titleCenter="center"===this.titlePos,this.titleOpposite="left"===this.titlePos):(delete this.titleFont,delete this.titleOffset,delete this.titlePos),this.labelsFont=this.v7EvalFont("labels",{size:t?.05:.03}),this.labelsFont.roundAngle(180),this.labelsFont.angle&&(this.labelsFont.angle=270),this.labelsOffset=this.v7EvalLength("labels_offset",this.scalingSize,0),t&&(this.ticksSize=.5*this.labelsFont.size),this.maxTickSize&&this.ticksSize>this.maxTickSize&&(this.ticksSize=this.maxTickSize)}async drawAxis(t,e,s){let i=t;void 0===s&&(s=1),this.standalone||(i=t.selectChild(`.${this.name}_container`),i.empty()?i=t.append("svg:g").attr("class",`${this.name}_container`):i.selectAll("*").remove()),i.attr("transform",e),this.extractDrawAttributes(),this.axis_g=i,this.side=s,"invert"===this.ticksSide&&(s=-s),this.standalone&&this.drawMainLine(i);this.handle=this.createTicks(!1,!1,!1,!1);const a=this.drawTicks(i,s,!0);return(this.optionUnlab?Promise.resolve(a):this.drawLabels(i,s,a)).then((t=>(this.addZoomingRect(i,this.standalone?s:this.side,t),this.drawTitle(i,s,t))))}setAfterDrawHandler(t){this._afterDrawAgain=t}drawAxisAgain(){if(!this.axis_g||!this.side)return;this.axis_g.selectAll("*").remove(),this.extractDrawAttributes();let t=this.side;"invert"===this.ticksSide&&(t=-t),this.standalone&&this.drawMainLine(this.axis_g);const e=this.drawTicks(this.axis_g,t,!1);return(this.optionUnlab?Promise.resolve(e):this.drawLabels(this.axis_g,t,e)).then((e=>(this.addZoomingRect(this.axis_g,this.standalone?t:this.side,e),this.drawTitle(this.axis_g,t,e)))).then((()=>{(0,i.isFunc)(this._afterDrawAgain)&&this._afterDrawAgain()}))}drawAxisOtherPlace(t,e,s,i){let a=t.selectChild(`.${this.name}_container2`);a.empty()?a=t.append("svg:g").attr("class",`${this.name}_container2`):a.selectAll("*").remove(),a.attr("transform",e),"invert"===this.ticksSide&&(s=-s);const n=this.drawTicks(a,s,!1);return(this.optionUnlab||i?Promise.resolve(n):this.drawLabels(a,s,n)).then((t=>(this.addZoomingRect(a,s,t),!0)))}zoomStandalone(t,e){this.changeAxisAttr(1,"zoomMin",t,"zoomMax",e)}redraw(){const t=this.getObject(),e=this.getPadPainter(),s=e.getCoordinate(t.fPos),h=this.v7EvalAttr("reverse",!1),l=t.fLabels.length,d=l>0?0:this.v7EvalAttr("min",0),c=l>0?l:this.v7EvalAttr("max",100);let g=e.getPadLength(t.fVertical,t.fLength);t.fVertical&&(g-=e.getPadHeight());let m=this.v7EvalAttr("zoomMin"),u=this.v7EvalAttr("zoomMax");m===u&&(m=d,u=c),this.configureAxis("axis",d,c,m,u,t.fVertical,void 0,g,{reverse:h,labels:l>0}),this.createG(),this.standalone=!0;const _=this.drawAxis(this.draw_g,(0,n.bk)(s.x,s.y));return this.isBatchMode()?_:_.then((()=>{i.settings.ContextMenu&&this.draw_g.on("contextmenu",(t=>{t.stopPropagation(),t.preventDefault(),(0,r.ES)(t,this).then((t=>{t.add("header:RAxisDrawable"),t.add("Unzoom",(()=>this.zoomStandalone())),this.fillAxisContextMenu(t,""),t.show()}))})),(0,o.WJ)(this,{x:s.x,y:s.y,width:this.vertical?10:g,height:this.vertical?g:10,only_move:!0,redraw:t=>this.positionChanged(t)}),this.draw_g.on("dblclick",(()=>this.zoomStandalone())),i.settings.ZoomWheel&&this.draw_g.on("wheel",(t=>{t.stopPropagation(),t.preventDefault();const e=(0,a.Wn)(t,this.draw_g.node()),s=this.vertical?1-e[1]/g:e[0]/g,i=this.analyzeWheelEvent(t,s);i.changed&&this.zoomStandalone(i.min,i.max)}))}))}positionChanged(t){const e=this.getObject(),s=this.getPadPainter().getPadRect(),i=t.x/s.width,a=1-t.y/s.height;e.fPos.fHoriz.fArr=[i],e.fPos.fVert.fArr=[a],this.submitCanvExec(`SetPos({${i.toFixed(4)},${a.toFixed(4)}})`)}changeAxisAttr(t){const e={};let s=1;for(;s<arguments.length-1;)this.v7AttrChange(e,arguments[s],arguments[s+1]),this.v7SetAttr(arguments[s],arguments[s+1]),s+=2;this.v7SendAttrChanges(e,!1),1===t?this.standalone?this.redraw():this.drawAxisAgain():t&&this.redrawPad()}changeAxisLog(t){this.kind!==l.ei&&this.kind!==l.Yu&&("toggle"===t&&(t=this.log?0:10),t=parseFloat(t),Number.isFinite(t)&&this.changeAxisAttr(2,"log",t,"symlog",0))}fillAxisContextMenu(t,e){return e&&t.add("Unzoom",(()=>this.getFramePainter().unzoom(e))),t.add("sub:Log scale",(()=>this.changeAxisLog("toggle"))),t.addchk(!this.log&&!this.symlog,"linear",0,(t=>this.changeAxisLog(t))),t.addchk(this.log&&!this.symlog&&10===this.logbase,"log10",(()=>this.changeAxisLog(10))),t.addchk(this.log&&!this.symlog&&2===this.logbase,"log2",(()=>this.changeAxisLog(2))),t.addchk(this.log&&!this.symlog&&Math.abs(this.logbase-Math.exp(1))<.1,"ln",(()=>this.changeAxisLog(Math.exp(1)))),t.addchk(!this.log&&this.symlog,"symlog",0,(()=>t.input("set symlog constant",this.symlog||10,"float").then((t=>this.changeAxisAttr(2,"symlog",t))))),t.add("endsub:"),t.add("Divisions",(()=>t.input("Set axis devisions",this.v7EvalAttr("ndiv",508),"int").then((t=>this.changeAxisAttr(2,"ndiv",t))))),t.add("sub:Ticks"),t.addRColorMenu("color",this.ticksColor,(t=>this.changeAxisAttr(1,"ticks_color",t))),t.addSizeMenu("size",0,.05,.01,this.ticksSize/this.scalingSize,(t=>this.changeAxisAttr(1,"ticks_size",t))),t.addSelectMenu("side",["normal","invert","both"],this.ticksSide,(t=>this.changeAxisAttr(1,"ticks_side",t))),t.add("endsub:"),!this.optionUnlab&&this.labelsFont&&(t.add("sub:Labels"),t.addSizeMenu("offset",-.05,.05,.01,this.labelsOffset/this.scalingSize,(t=>this.changeAxisAttr(1,"labels_offset",t))),t.addRAttrTextItems(this.labelsFont,{noangle:1,noalign:1},(t=>this.changeAxisAttr(1,"labels_"+t.name,t.value))),t.addchk(this.labelsFont.angle,"rotate",(t=>this.changeAxisAttr(1,"labels_angle",t?180:0))),t.add("endsub:")),t.add("sub:Title",(()=>t.input("Enter axis title",this.fTitle).then((t=>this.changeAxisAttr(1,"title_value",t))))),this.fTitle&&(t.addSizeMenu("offset",-.05,.05,.01,this.titleOffset/this.scalingSize,(t=>this.changeAxisAttr(1,"title_offset",t))),t.addSelectMenu("position",["left","center","right"],this.titlePos,(t=>this.changeAxisAttr(1,"title_position",t))),t.addchk(this.isTitleRotated(),"rotate",(t=>this.changeAxisAttr(1,"title_angle",t?180:0))),t.addRAttrTextItems(this.titleFont,{noangle:1,noalign:1},(t=>this.changeAxisAttr(1,"title_"+t.name,t.value)))),t.add("endsub:"),!0}}},4709:(t,e,s)=>{s.r(e),s.d(e,{RCanvasPainter:()=>R,RObjectPainter:()=>l.D,RPadPainter:()=>x,drawRAxis:()=>$,drawRFont:()=>D,drawRFrame:()=>T,drawRFrameTitle:()=>F,drawRPadSnapshot:()=>E,ensureRCanvas:()=>O});var i=s(9490),a=s(8260),n=s(9726),h=s(1227),r=s(1597),o=s(6950),l=s(7243),d=s(8094),c=s(3960),g=s(1488),m=s(7124);class u extends l.D{constructor(t,e){super(t,e,"","frame"),this.mode3d=!1,this.xmin=this.xmax=0,this.ymin=this.ymax=0,this.axes_drawn=!1,this.keys_handler=null,this.projection=0,this.v7_frame=!0}getFramePainter(){return this}is_root6(){return!1}setFrameActive(t){this.enabledKeys=t&&i.settings.HandleKeys,this.control&&(this.control.enableKeys=this.enabledKeys)}setLastEventPos(t){this.fLastEventPnt=t}getLastEventPos(){return this.fLastEventPnt}updateAttributes(t){if(void 0===this.fX1NDC||t&&!this.modified_NDC){const t=this.getPadPainter().getPadRect();this.fX1NDC=this.v7EvalLength("margins_left",t.width,i.gStyle.fPadLeftMargin)/t.width,this.fY1NDC=this.v7EvalLength("margins_bottom",t.height,i.gStyle.fPadBottomMargin)/t.height,this.fX2NDC=1-this.v7EvalLength("margins_right",t.width,i.gStyle.fPadRightMargin)/t.width,this.fY2NDC=1-this.v7EvalLength("margins_top",t.height,i.gStyle.fPadTopMargin)/t.height}this.fillatt||this.createv7AttFill(),this.createv7AttLine("border_")}getProjectionFunc(){return(0,m.qP)(this.projection)}recalculateRange(t){this.projection=t||0,2===this.projection&&(this.scale_ymin<=-90||this.scale_ymax>=90)&&(console.warn(`Mercator Projection: latitude out of range ${this.scale_ymin} ${this.scale_ymax}`),this.projection=0);const e=this.getProjectionFunc();if(!e)return;const s=[e(this.scale_xmin,this.scale_ymin),e(this.scale_xmin,this.scale_ymax),e(this.scale_xmax,this.scale_ymax),e(this.scale_xmax,this.scale_ymin)];this.scale_xmin<0&&this.scale_xmax>0&&(s.push(e(0,this.scale_ymin)),s.push(e(0,this.scale_ymax))),this.scale_ymin<0&&this.scale_ymax>0&&(s.push(e(this.scale_xmin,0)),s.push(e(this.scale_xmax,0))),this.original_xmin=this.scale_xmin,this.original_xmax=this.scale_xmax,this.original_ymin=this.scale_ymin,this.original_ymax=this.scale_ymax,this.scale_xmin=this.scale_xmax=s[0].x,this.scale_ymin=this.scale_ymax=s[0].y;for(let i=1;i<s.length;++i)this.scale_xmin=Math.min(this.scale_xmin,s[i].x),this.scale_xmax=Math.max(this.scale_xmax,s[i].x),this.scale_ymin=Math.min(this.scale_ymin,s[i].y),this.scale_ymax=Math.max(this.scale_ymax,s[i].y)}drawGrids(){const t=this.getFrameSvg().selectChild(".axis_layer");t.selectAll(".xgrid").remove(),t.selectAll(".ygrid").remove();const e=this.getFrameHeight(),s=this.getFrameWidth(),a=this.v7EvalAttr("gridX",!1),n=this.v7EvalAttr("gridY",!1),h=(0,c.Ov)(i.gStyle.fGridStyle),r=i.gStyle.fGridColor>0?this.getColor(i.gStyle.fGridColor):"black";if(this.x_handle&&(this.x_handle.draw_grid=a),this.x_handle?.draw_grid){let a="";for(let t=0;t<this.x_handle.ticks.length;++t)a+=this.swap_xy?`M0,${e+this.x_handle.ticks[t]}h${s}`:`M${this.x_handle.ticks[t]},0v${e}`;a&&t.append("svg:path").attr("class","xgrid").attr("d",a).style("stroke",r).style("stroke-width",i.gStyle.fGridWidth).style("stroke-dasharray",h)}if(this.y_handle&&(this.y_handle.draw_grid=n),this.y_handle?.draw_grid){let a="";for(let t=0;t<this.y_handle.ticks.length;++t)a+=this.swap_xy?`M${this.y_handle.ticks[t]},0v${e}`:`M0,${e+this.y_handle.ticks[t]}h${s}`;a&&t.append("svg:path").attr("class","ygrid").attr("d",a).style("stroke",r).style("stroke-width",i.gStyle.fGridWidth).style("stroke-dasharray",h)}}axisAsText(t,e){const s=this[`${t}_handle`];return s?s.axisAsText(e,i.settings[t.toUpperCase()+"ValuesFormat"]):e.toPrecision(4)}_setAxisRange(t,e,s){const i=`${t}min`,a=`${t}max`;if(this[i]!==this[a])return;let n=this.v7EvalAttr(`${t}_min`),h=this.v7EvalAttr(`${t}_max`);void 0!==n&&(e=n),void 0!==h&&(s=h),e<s&&(this[i]=e,this[a]=s);const r=`zoom_${t}min`,o=`zoom_${t}max`;this[r]!==this[o]||this.zoomChangedInteractive(t)||(n=this.v7EvalAttr(`${t}_zoomMin`),h=this.v7EvalAttr(`${t}_zoomMax`),void 0===n&&void 0===h||(this[r]=void 0===n?this[i]:n,this[o]=void 0===h?this[a]:h))}setAxesRanges(t,e,s,i,a,n,h,r,o){this.axes_drawn||(this.xaxis=t,this._setAxisRange("x",e,s),this.yaxis=i,this._setAxisRange("y",a,n),this.zaxis=h,this._setAxisRange("z",r,o))}setAxes2Ranges(t,e,s,i,a,n,h,r){t&&(this.x2axis=e,this._setAxisRange("x2",s,i)),a&&(this.y2axis=n,this._setAxisRange("y2",h,r))}createXY(t){if(this.self_drawaxes)return;this.cleanXY(),t||(t={ndim:1}),this.v6axes=!0,this.swap_xy=t.swap_xy||!1,this.reverse_x=t.reverse_x||!1,this.reverse_y=t.reverse_y||!1,this.logx=this.v7EvalAttr("x_log",0),this.logy=this.v7EvalAttr("y_log",0);const e=this.getFrameWidth(),s=this.getFrameHeight();if(this.scales_ndim=t.ndim,this.scale_xmin=this.xmin,this.scale_xmax=this.xmax,this.scale_ymin=this.ymin,this.scale_ymax=this.ymax,t.extra_y_space){(this.swap_xy?this.logx:this.logy)&&this.scale_ymax>0?this.scale_ymax=Math.exp(1.1*Math.log(this.scale_ymax)):this.scale_ymax+=.1*(this.scale_ymax-this.scale_ymin)}t.zoom_xmin===t.zoom_xmax||this.zoom_xmin!==this.zoom_xmax&&this.zoomChangedInteractive("x")||(this.zoom_xmin=t.zoom_xmin,this.zoom_xmax=t.zoom_xmax),t.zoom_ymin===t.zoom_ymax||this.zoom_ymin!==this.zoom_ymax&&this.zoomChangedInteractive("y")||(this.zoom_ymin=t.zoom_ymin,this.zoom_ymax=t.zoom_ymax),this.zoom_xmin!==this.zoom_xmax&&(this.scale_xmin=this.zoom_xmin,this.scale_xmax=this.zoom_xmax),this.zoom_ymin!==this.zoom_ymax&&(this.scale_ymin=this.zoom_ymin,this.scale_ymax=this.zoom_ymax);let a=this.xaxis,n=this.yaxis;a?._typename!==i.clTAxis&&(a=(0,i.create)(i.clTAxis)),n?._typename!==i.clTAxis&&(n=(0,i.create)(i.clTAxis)),this.x_handle=new g.TB(this.getDom(),a,!0),this.x_handle.setPadName(this.getPadName()),this.x_handle.optionUnlab=this.v7EvalAttr("x_labels_hide",!1),this.x_handle.configureAxis("xaxis",this.xmin,this.xmax,this.scale_xmin,this.scale_xmax,this.swap_xy,this.swap_xy?[0,s]:[0,e],{reverse:this.reverse_x,log:this.swap_xy?this.logy:this.logx,symlog:this.swap_xy?t.symlog_y:t.symlog_x,logcheckmin:this.swap_xy,logminfactor:1e-4}),this.x_handle.assignFrameMembers(this,"x"),this.y_handle=new g.TB(this.getDom(),n,!0),this.y_handle.setPadName(this.getPadName()),this.y_handle.optionUnlab=this.v7EvalAttr("y_labels_hide",!1),this.y_handle.configureAxis("yaxis",this.ymin,this.ymax,this.scale_ymin,this.scale_ymax,!this.swap_xy,this.swap_xy?[0,e]:[0,s],{reverse:this.reverse_y,log:this.swap_xy?this.logx:this.logy,symlog:this.swap_xy?t.symlog_x:t.symlog_y,logcheckmin:t.ndim<2||this.swap_xy,log_min_nz:t.ymin_nz&&t.ymin_nz<this.ymax?.5*t.ymin_nz:0,logminfactor:3e-4}),this.y_handle.assignFrameMembers(this,"y")}hasDrawnAxes(t,e){return!t&&!e&&this.axes_drawn}async drawAxes(){if(this.axes_drawn||this.xmin===this.xmax||this.ymin===this.ymax)return this.axes_drawn;const t=this.v7EvalAttr("ticksX",1),e=this.v7EvalAttr("ticksY",1);let s=1,i=1;this.v7EvalAttr("swapX",!1)&&(s=-1),this.v7EvalAttr("swapY",!1)&&(i=-1);const a=this.getFrameWidth(),n=this.getFrameHeight();this.v6axes||(this.cleanupAxes(),this.swap_xy=!1,this.zoom_xmin!==this.zoom_xmax?(this.scale_xmin=this.zoom_xmin,this.scale_xmax=this.zoom_xmax):(this.scale_xmin=this.xmin,this.scale_xmax=this.xmax),this.zoom_ymin!==this.zoom_ymax?(this.scale_ymin=this.zoom_ymin,this.scale_ymax=this.zoom_ymax):(this.scale_ymin=this.ymin,this.scale_ymax=this.ymax),this.recalculateRange(0),this.x_handle=new d.R(this.getDom(),this,this.xaxis,"x_"),this.x_handle.setPadName(this.getPadName()),this.x_handle.snapid=this.snapid,this.x_handle.draw_swapside=s<0,this.x_handle.draw_ticks=t,this.y_handle=new d.R(this.getDom(),this,this.yaxis,"y_"),this.y_handle.setPadName(this.getPadName()),this.y_handle.snapid=this.snapid,this.y_handle.draw_swapside=i<0,this.y_handle.draw_ticks=e,this.z_handle=new d.R(this.getDom(),this,this.zaxis,"z_"),this.z_handle.setPadName(this.getPadName()),this.z_handle.snapid=this.snapid,this.x_handle.configureAxis("xaxis",this.xmin,this.xmax,this.scale_xmin,this.scale_xmax,!1,[0,a],a,{reverse:!1}),this.x_handle.assignFrameMembers(this,"x"),this.y_handle.configureAxis("yaxis",this.ymin,this.ymax,this.scale_ymin,this.scale_ymax,!0,[n,0],-n,{reverse:!1}),this.y_handle.assignFrameMembers(this,"y"),this.z_handle.configureZAxis("zaxis",this));const h=this.getFrameSvg().selectChild(".axis_layer");this.x_handle.has_obstacle=!1;const o=this.swap_xy?this.y_handle:this.x_handle,l=this.swap_xy?this.x_handle:this.y_handle;let c;if(this.getPadPainter()?._fast_drawing)c=Promise.resolve(!0);else if(this.v6axes){const s=!1,i=!1,r=!1;o.disable_ticks=t<=0,l.disable_ticks=e<=0;const d=o.drawAxis(h,a,n,o.invert_side?null:`translate(0,${n})`,t>1?-n:0,i,void 0,!1,this.getPadPainter().getPadHeight()-n-this.getFrameY()),g=l.drawAxis(h,a,n,l.invert_side?`translate(${a})`:null,e>1?a:0,r,l.invert_side?0:this._frame_x,s);c=Promise.all([d,g]).then((()=>this.drawGrids()))}else{let d=[];t>0&&d.push(o.drawAxis(h,(0,r.bk)(0,s>0?n:0),s)),e>0&&d.push(l.drawAxis(h,(0,r.bk)(i>0?0:a,n),i)),c=Promise.all(d).then((()=>(d=[],t>1&&d.push(o.drawAxisOtherPlace(h,(0,r.bk)(0,s<0?n:0),-s,2===t)),e>1&&d.push(l.drawAxisOtherPlace(h,(0,r.bk)(i<0?0:a,n),-i,2===e)),Promise.all(d)))).then((()=>this.drawGrids()))}return c.then((()=>(this.axes_drawn=!0,!0)))}drawAxes2(t,e){const s=this.getFrameWidth(),i=this.getFrameHeight(),a=this.getFrameSvg().selectChild(".axis_layer");let n,h;return t&&(this.zoom_x2min!==this.zoom_x2max?(this.scale_x2min=this.zoom_x2min,this.scale_x2max=this.zoom_x2max):(this.scale_x2min=this.x2min,this.scale_x2max=this.x2max),this.x2_handle=new d.R(this.getDom(),this,this.x2axis,"x2_"),this.x2_handle.setPadName(this.getPadName()),this.x2_handle.snapid=this.snapid,this.x2_handle.configureAxis("x2axis",this.x2min,this.x2max,this.scale_x2min,this.scale_x2max,!1,[0,s],s,{reverse:!1}),this.x2_handle.assignFrameMembers(this,"x2"),n=this.x2_handle.drawAxis(a,null,-1)),e&&(this.zoom_y2min!==this.zoom_y2max?(this.scale_y2min=this.zoom_y2min,this.scale_y2max=this.zoom_y2max):(this.scale_y2min=this.y2min,this.scale_y2max=this.y2max),this.y2_handle=new d.R(this.getDom(),this,this.y2axis,"y2_"),this.y2_handle.setPadName(this.getPadName()),this.y2_handle.snapid=this.snapid,this.y2_handle.configureAxis("y2axis",this.y2min,this.y2max,this.scale_y2min,this.scale_y2max,!0,[i,0],-i,{reverse:!1}),this.y2_handle.assignFrameMembers(this,"y2"),h=this.y2_handle.drawAxis(a,(0,r.bk)(s,i),-1)),Promise.all([n,h])}getGrFuncs(t,e){const s=t&&this.grx2,i=e&&this.gry2;return s||i?{use_x2:s,grx:s?this.grx2:this.grx,x_handle:s?this.x2_handle:this.x_handle,logx:s?this.x2_handle.log:this.x_handle.log,scale_xmin:s?this.scale_x2min:this.scale_xmin,scale_xmax:s?this.scale_x2max:this.scale_xmax,use_y2:i,gry:i?this.gry2:this.gry,y_handle:i?this.y2_handle:this.y_handle,logy:i?this.y2_handle.log:this.y_handle.log,scale_ymin:i?this.scale_y2min:this.scale_ymin,scale_ymax:i?this.scale_y2max:this.scale_ymax,swap_xy:this.swap_xy,fp:this,revertAxis(t,e){return"x"===t&&this.use_x2&&(t="x2"),"y"===t&&this.use_y2&&(t="y2"),this.fp.revertAxis(t,e)},axisAsText(t,e){return"x"===t&&this.use_x2&&(t="x2"),"y"===t&&this.use_y2&&(t="y2"),this.fp.axisAsText(t,e)}}:this}sizeChanged(){const t={};this.v7AttrChange(t,"margins_left",this.fX1NDC),this.v7AttrChange(t,"margins_bottom",this.fY1NDC),this.v7AttrChange(t,"margins_right",1-this.fX2NDC),this.v7AttrChange(t,"margins_top",1-this.fY2NDC),this.v7SendAttrChanges(t,!1),this.redrawPad()}cleanXY(){const t=(t,e)=>{this[t]?.cleanup(),delete this[t],delete this[e]};t("x_handle","grx"),t("y_handle","gry"),t("z_handle","grz"),t("x2_handle","grx2"),t("y2_handle","gry2"),delete this.v6axes}cleanupAxes(){this.cleanXY(),this.draw_g?.selectChild(".axis_layer").selectAll("*").remove(),this.axes_drawn=!1}cleanFrameDrawings(){(0,i.isFunc)(this.create3DScene)&&this.create3DScene(-1),this.cleanupAxes();const t=t=>{this[t+"min"]=this[t+"max"]=0,this[`zoom_${t}min`]=this[`zoom_${t}max`]=0,this[`scale_${t}min`]=this[`scale_${t}max`]=0};t("x"),t("y"),t("z"),t("x2"),t("y2"),this.draw_g?.selectChild(".main_layer").selectAll("*").remove(),this.draw_g?.selectChild(".upper_layer").selectAll("*").remove()}cleanup(){this.cleanFrameDrawings(),this.draw_g&&(this.draw_g.selectAll("*").remove(),this.draw_g.on("mousedown",null).on("dblclick",null).on("wheel",null).on("contextmenu",null).property("interactive_set",null)),this.keys_handler&&(window.removeEventListener("keydown",this.keys_handler,!1),this.keys_handler=null),delete this.enabledKeys,delete this.self_drawaxes,delete this.xaxis,delete this.yaxis,delete this.zaxis,delete this.x2axis,delete this.y2axis,delete this.draw_g,delete this._click_handler,delete this._dblclick_handler;const t=this.getPadPainter();t?.frame_painter_ref===this&&delete t.frame_painter_ref,super.cleanup()}redraw(){const t=this.getPadPainter();t&&(t.frame_painter_ref=this),this.updateAttributes();const e=t?.getPadRect()??{width:10,height:10},s=Math.round(e.width*this.fX1NDC),i=Math.round(e.height*(1-this.fY2NDC));let a,n,h,o=Math.round(e.width*(this.fX2NDC-this.fX1NDC)),l=Math.round(e.height*(this.fY2NDC-this.fY1NDC)),d=!1,c=!1;if(t?.options&&(t.options.RotateFrame&&(d=!0),t.options.FixFrame&&(c=!0)),d?(a=`rotate(-90,${s},${i}) translate(${s-l},${i})`,[o,l]=[l,o]):a=(0,r.bk)(s,i),this._frame_x=s,this._frame_y=i,this._frame_width=o,this._frame_height=l,this._frame_rotate=d,this._frame_fixpos=c,this.mode3d)return this;this.draw_g=this.getFrameSvg(),this.draw_g.empty()?(this.draw_g=this.getLayerSvg("primitives_layer").append("svg:g").attr("class","root_frame"),this.isBatchMode()||this.draw_g.append("svg:title").text(""),n=this.draw_g.append("svg:rect"),h=this.draw_g.append("svg:svg").attr("class","main_layer").attr("x",0).attr("y",0).attr("overflow","hidden"),this.draw_g.append("svg:g").attr("class","axis_layer"),this.draw_g.append("svg:g").attr("class","upper_layer")):(n=this.draw_g.selectChild("rect"),h=this.draw_g.selectChild(".main_layer")),this.axes_drawn=!1,this.draw_g.attr("transform",a),n.attr("x",0).attr("y",0).attr("width",o).attr("height",l).attr("rx",this.lineatt.rx||null).attr("ry",this.lineatt.ry||null).call(this.fillatt.func).call(this.lineatt.func),h.attr("width",o).attr("height",l).attr("viewBox",`0 0 ${o} ${l}`);let g=Promise.resolve(!0);return this.v7EvalAttr("drawAxes")&&(this.self_drawaxes=!0,this.setAxesRanges(),g=this.drawAxes().then((()=>this.addInteractivity()))),g.then((()=>this))}getFrameX(){return this._frame_x||0}getFrameY(){return this._frame_y||0}getFrameWidth(){return this._frame_width||0}getFrameHeight(){return this._frame_height||0}getFrameRect(){return{x:this._frame_x||0,y:this._frame_y||0,width:this.getFrameWidth(),height:this.getFrameHeight(),transform:this.draw_g?.attr("transform")||"",hint_delta_x:0,hint_delta_y:0}}getHistPalette(){return this.getPadPainter().getHistPalette()}configureUserClickHandler(t){this._click_handler=(0,i.isFunc)(t)?t:null}configureUserDblclickHandler(t){this._dblclick_handler=(0,i.isFunc)(t)?t:null}async zoom(t,e,s,a,n,h){if(this.projection)return!1;"x"===t?(t=e,e=s,s=void 0):"y"===t?(a=s,s=e,t=e=void 0):"z"===t&&(n=e,h=s,t=e=s=void 0);let r=t!==e,o=s!==a,l=n!==h,d=!1,c=!1,g=!1;if(r){let s=0;t<=this.xmin&&(t=this.xmin,s++),e>=this.xmax&&(e=this.xmax,s++),2===s&&(r=!1,d=!0)}else d=t===e&&0===t;if(o){let t=0;s<=this.ymin&&(s=this.ymin,t++),a>=this.ymax&&(a=this.ymax,t++),2===t&&(o=!1,c=!0)}else c=s===a&&0===s;if(l){let t=0;n<=this.zmin&&(n=this.zmin,t++),h>=this.zmax&&(h=this.zmax,t++),2===t&&(l=!1,g=!0)}else g=n===h&&0===n;let m=!1,u="",_="",f="",p=!1;const x={_typename:`${i.nsREX}RFrame::RUserRanges`,values:[0,0,0,0,0,0],flags:[!1,!1,!1,!1,!1,!1]},v=(d,c)=>{(c||(0,i.isFunc)(d.canZoomInside))&&(p=!0,r&&(c||d.canZoomInside("x",t,e))&&(this.zoom_xmin=t,this.zoom_xmax=e,m=!0,u="0",r=!1,x.values[0]=t,x.values[1]=e,x.flags[0]=x.flags[1]=!0),o&&(c||d.canZoomInside("y",s,a))&&(this.zoom_ymin=s,this.zoom_ymax=a,m=!0,_="1",o=!1,x.values[2]=s,x.values[3]=a,x.flags[2]=x.flags[3]=!0),l&&(c||d.canZoomInside("z",n,h))&&(this.zoom_zmin=n,this.zoom_zmax=h,m=!0,f="2",l=!1,x.values[4]=n,x.values[5]=h,x.flags[4]=x.flags[5]=!0))};return(r||o||l)&&this.forEachPainter((t=>v(t))),!p&&this.self_drawaxes&&v(null,!0),(d||c||g)&&(d&&(this.zoom_xmin!==this.zoom_xmax&&(m=!0,u="0"),this.zoom_xmin=this.zoom_xmax=0,x.values[0]=x.values[1]=-1),c&&(this.zoom_ymin!==this.zoom_ymax&&(m=!0,_="1"),this.zoom_ymin=this.zoom_ymax=0,x.values[2]=x.values[3]=-1),g&&(this.zoom_zmin!==this.zoom_zmax&&(m=!0,f="2"),this.zoom_zmin=this.zoom_zmax=0,x.values[4]=x.values[5]=-1)),!!m&&(this.v7NormalMode()&&this.v7SubmitRequest("zoom",{_typename:`${i.nsREX}RFrame::RZoomRequest`,ranges:x}),this.interactiveRedraw("pad","zoom"+u+_+f).then((()=>!0)))}async zoomSingle(t,e,s){const a=["x","y","z","x2","y2"].indexOf(t);if(this.projection||!this[t+"_handle"]||a<0)return!1;let n=e!==s,h=!1;if(n){let i=0;e<=this[t+"min"]&&(e=this[t+"min"],i++),s>=this[t+"max"]&&(s=this[t+"max"],i++),2===i&&(n=!1,h=!0)}else h=e===s&&0===e;let r=!1,o=!1;const l={_typename:`${i.nsREX}RFrame::RUserRanges`,values:[0,0,0,0,0,0,0,0,0,0],flags:[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1]},d=(h,d)=>{(d||(0,i.isFunc)(h?.canZoomInside))&&(o=!0,n&&(d||h.canZoomInside(t[0],e,s))&&(this["zoom_"+t+"min"]=e,this["zoom_"+t+"max"]=s,r=!0,n=!1,l.values[2*a]=e,l.values[2*a+1]=s,l.flags[2*a]=l.flags[2*a+1]=!0))};return n&&this.forEachPainter((t=>d(t))),!o&&this.self_drawaxes&&d(null,!0),h&&(this[`zoom_${t}min`]!==this[`zoom_${t}max`]&&(r=!0),this[`zoom_${t}min`]=this[`zoom_${t}max`]=0,l.values[2*a]=l.values[2*a+1]=-1),!!r&&(this.v7NormalMode()&&this.v7SubmitRequest("zoom",{_typename:`${i.nsREX}RFrame::RZoomRequest`,ranges:l}),this.interactiveRedraw("pad",`zoom${a}`).then((()=>!0)))}isAxisZoomed(t){return this[`zoom_${t}min`]!==this[`zoom_${t}max`]}async unzoom(t,e,s){return"all"===t?this.unzoom("x2").then((()=>this.unzoom("y2"))).then((()=>this.unzoom("xyz"))):"x2"===t||"y2"===t?this.zoomSingle(t,0,0).then((e=>(e&&this.zoomChangedInteractive(t,"unzoom"),e))):("undefined"===typeof t?t=e=s=!0:(0,i.isStr)(t)&&(s=t.indexOf("z")>=0,e=t.indexOf("y")>=0,t=t.indexOf("x")>=0),this.zoom(t?0:void 0,t?0:void 0,e?0:void 0,e?0:void 0,s?0:void 0,s?0:void 0).then((i=>(i&&t&&this.zoomChangedInteractive("x","unzoom"),i&&e&&this.zoomChangedInteractive("y","unzoom"),i&&s&&this.zoomChangedInteractive("z","unzoom"),i))))}zoomChangedInteractive(t,e){if("reset"===t)return void(this.zoom_changed_x=this.zoom_changed_y=this.zoom_changed_z=void 0);if(!t||"any"===t)return this.zoom_changed_x||this.zoom_changed_y||this.zoom_changed_z;if("x"!==t&&"y"!==t&&"z"!==t)return;const s="zoom_changed_"+t;if(void 0===e)return this[s];"unzoom"!==e?e&&(this[s]=!0):this[s]=void 0===this[s]}fillObjectOfflineMenu(t,e){"x"!==e&&"y"!==e||t.add("Unzoom",(()=>this.unzoom(e)))}changeFrameAttr(t,e){const s={};this.v7AttrChange(s,t,e),this.v7SetAttr(t,e),this.v7SendAttrChanges(s,!1),this.redrawPad()}fillContextMenu(t,e){if("pal"===e&&(e="z"),"x"===e||"y"===e||"x2"===e||"y2"===e){const s=this[e+"_handle"];return!!s&&(t.add("header: "+e.toUpperCase()+" axis"),s.fillAxisContextMenu(t,e))}const s=0===t.size();return s?t.add("header:Frame"):t.add("separator"),this.zoom_xmin!==this.zoom_xmax&&t.add("Unzoom X",(()=>this.unzoom("x"))),this.zoom_ymin!==this.zoom_ymax&&t.add("Unzoom Y",(()=>this.unzoom("y"))),this.zoom_zmin!==this.zoom_zmax&&t.add("Unzoom Z",(()=>this.unzoom("z"))),this.zoom_x2min!==this.zoom_x2max&&t.add("Unzoom X2",(()=>this.unzoom("x2"))),this.zoom_y2min!==this.zoom_y2max&&t.add("Unzoom Y2",(()=>this.unzoom("y2"))),t.add("Unzoom all",(()=>this.unzoom("all"))),t.add("separator"),t.addchk(this.isTooltipAllowed(),"Show tooltips",(()=>this.setTooltipAllowed("toggle"))),this.x_handle&&t.addchk(this.x_handle.draw_grid,"Grid x",(t=>this.changeFrameAttr("gridX",t))),this.y_handle&&t.addchk(this.y_handle.draw_grid,"Grid y",(t=>this.changeFrameAttr("gridY",t))),this.x_handle&&!this.x2_handle&&t.addchk(this.x_handle.draw_swapside,"Swap x",(t=>this.changeFrameAttr("swapX",t))),this.y_handle&&!this.y2_handle&&t.addchk(this.y_handle.draw_swapside,"Swap y",(t=>this.changeFrameAttr("swapY",t))),this.x_handle&&!this.x2_handle&&(t.add("sub:Ticks x"),t.addchk(0===this.x_handle.draw_ticks,"off",(()=>this.changeFrameAttr("ticksX",0))),t.addchk(1===this.x_handle.draw_ticks,"normal",(()=>this.changeFrameAttr("ticksX",1))),t.addchk(2===this.x_handle.draw_ticks,"ticks on both sides",(()=>this.changeFrameAttr("ticksX",2))),t.addchk(3===this.x_handle.draw_ticks,"labels on both sides",(()=>this.changeFrameAttr("ticksX",3))),t.add("endsub:")),this.y_handle&&!this.y2_handle&&(t.add("sub:Ticks y"),t.addchk(0===this.y_handle.draw_ticks,"off",(()=>this.changeFrameAttr("ticksY",0))),t.addchk(1===this.y_handle.draw_ticks,"normal",(()=>this.changeFrameAttr("ticksY",1))),t.addchk(2===this.y_handle.draw_ticks,"ticks on both sides",(()=>this.changeFrameAttr("ticksY",2))),t.addchk(3===this.y_handle.draw_ticks,"labels on both sides",(()=>this.changeFrameAttr("ticksY",3))),t.add("endsub:")),t.addAttributesMenu(this,s?"":"Frame "),t.add("separator"),t.add("sub:Save as"),["svg","png","jpeg","pdf","webp"].forEach((e=>t.add(`frame.${e}`,(()=>this.getPadPainter().saveAs(e,"frame",`frame.${e}`))))),t.add("endsub:"),!0}revertAxis(t,e){return this[`${t}_handle`]?.revertPoint(e)??0}showAxisStatus(t,e){const s=t,i=(0,a.Wn)(e,this.getFrameSvg().node());let n="x"===t?0:1;this.swap_xy&&(n=1-n);const h=this.revertAxis(t,i[n]);this.showObjectStatus(s,"axis",`${t} : ${this.axisAsText(t,h)}`,`${Math.round(i[0])},${Math.round(i[1])}`)}addKeysHandler(){this.isBatchMode()||(m.wM.assign(this),this.addFrameKeysHandler())}addInteractivity(t){return!(!this.isBatchMode()&&(i.settings.Zooming||i.settings.ContextMenu))||(m.wM.assign(this),t||this.addBasicInteractivity(),this.addFrameInteractivity(t))}setRootPadRange(){}toggleAxisLog(t){const e=this[t+"_handle"];return e?.changeAxisLog("toggle")}}var _=s(4435),f=s(3558),p=s(2020);class x extends l.D{constructor(t,e,s){super(t,e,"","pad"),this.pad=e,this.iscan=s,this.this_pad_name="",this.iscan||null===e||(e.fObjectID?this.this_pad_name="pad"+e.fObjectID:this.this_pad_name="ppp"+i.internals.id_counter++),this.painters=[],this.has_canvas=!0,this.forEachPainter=this.forEachPainterInPad;const a=this.selectDom();!a.empty()&&a.property("_batch_mode")&&(this.batch_mode=!0)}isBatchMode(){return void 0!==this.batch_mode?this.batch_mode:!!(0,i.isBatchMode)()||!(this.iscan||!this.has_canvas)&&this.getCanvPainter()?.isBatchMode()}isRoot6(){return!1}isEditable(){return!0}svg_this_pad(){return this.getPadSvg(this.this_pad_name)}getMainPainter(){return this.main_painter_ref||null}setMainPainter(t,e){this.main_painter_ref&&!e||(this.main_painter_ref=t)}cleanup(){this._doing_draw&&console.error("pad drawing is not completed when cleanup is called"),this.painters.forEach((t=>t.cleanup()));const t=this.svg_this_pad();t.empty()||(t.property("pad_painter",null),this.iscan||t.remove()),delete this.main_painter_ref,delete this.frame_painter_ref,delete this.pads_cache,delete this._pad_x,delete this._pad_y,delete this._pad_width,delete this._pad_height,delete this._doing_draw,delete this._dfltRFont,this.painters=[],this.pad=null,this.draw_object=null,this.pad_frame=null,this.this_pad_name=void 0,this.has_canvas=!1,(0,o.QD)({pp:this,active:!1}),super.cleanup()}getFramePainter(){return this.frame_painter_ref}getPadWidth(){return this._pad_width||0}getPadHeight(){return this._pad_height||0}getPadLog(t){return!1}getPadRect(){return{x:this._pad_x||0,y:this._pad_y||0,width:this.getPadWidth(),height:this.getPadHeight()}}getFrameRect(){const t=this.getFramePainter();if(t)return t.getFrameRect();const e=this.getPadWidth(),s=this.getPadHeight(),i={};return i.szx=Math.round(.5*e),i.szy=Math.round(.5*s),i.width=2*i.szx,i.height=2*i.szy,i.x=Math.round(e/2-i.szx),i.y=Math.round(s/2-i.szy),i.hint_delta_x=i.szx,i.hint_delta_y=i.szy,i.transform=(0,r.bk)(i.x,i.y)||"",i}getRootPad(t){return void 0!==t&&t?null:this.pad}cleanPrimitives(t){if((0,i.isFunc)(t))for(let e=this.painters.length-1;e>=0;--e)t(this.painters[e])&&(this.painters[e].cleanup(),this.painters.splice(e,1))}removePrimitive(t){const e=this.painters[t],s=[];let i=t;for(let a=this.painters.length-1;a>=0;--a)(a===t||this.painters[a].isSecondary(e))&&(s.push(this.painters[a]),this.painters.splice(a,1),a<=t&&i--);return s.forEach((t=>{t.cleanup(),this.main_painter_ref===t&&(delete this.main_painter_ref,i=-111)})),i}findInPrimitives(t,e){return console.warn("findInPrimitives not implemented for RPad"),null}findPainterFor(t,e,s){return this.painters.find((i=>{const a=i.getObject();return!!a&&(!(!t||a!==t)||!(!e&&!s)&&((!e||a.fName===e)&&(!s||a._typename===s)))}))}getHistPalette(){const t=this.findPainterFor(void 0,void 0,`${i.nsREX}RPaletteDrawable`);return t?t.getHistPalette():(this.fDfltPalette||(this.fDfltPalette={_typename:`${i.nsREX}RPalette`,fColors:[{fOrdinal:0,fColor:{fColor:"rgb(53, 42, 135)"}},{fOrdinal:.125,fColor:{fColor:"rgb(15, 92, 221)"}},{fOrdinal:.25,fColor:{fColor:"rgb(20, 129, 214)"}},{fOrdinal:.375,fColor:{fColor:"rgb(6, 164, 202)"}},{fOrdinal:.5,fColor:{fColor:"rgb(46, 183, 164)"}},{fOrdinal:.625,fColor:{fColor:"rgb(135, 191, 119)"}},{fOrdinal:.75,fColor:{fColor:"rgb(209, 187, 89)"}},{fOrdinal:.875,fColor:{fColor:"rgb(254, 200, 50)"}},{fOrdinal:1,fColor:{fColor:"rgb(249, 251, 14)"}}],fInterpolate:!0,fNormalized:!0},(0,i.addMethods)(this.fDfltPalette,`${i.nsREX}RPalette`)),this.fDfltPalette)}getNumPainters(){return this.painters.length}forEachPainterInPad(t,e){e||(e="all"),"objects"!==e&&t(this);for(let s=0;s<this.painters.length;++s){const a=this.painters[s];(0,i.isFunc)(a.forEachPainterInPad)?"objects"!==e&&a.forEachPainterInPad(t,e):"pads"!==e&&t(a)}}registerForPadEvents(t){this.pad_events_receiver=t}producePadEvent(t,e,s,a,n){"select"===t&&(0,i.isFunc)(this.selectActivePad)&&this.selectActivePad(e,s,a),this.pad_events_receiver&&this.pad_events_receiver({what:t,padpainter:e,painter:s,position:a,place:n})}selectObjectPainter(t,e,s){const i=this.iscan||!this.has_canvas,a=i?this:this.getCanvPainter();void 0===t&&(t=this),e&&!i&&(e=(0,r.md)(this.svg_this_pad(),e)),(0,o.QD)({pp:this,active:!0}),a.producePadEvent("select",this,t,e,s)}setFastDrawing(t,e){const s=this._fast_drawing;this._fast_drawing=i.settings.SmallPad&&(t<i.settings.SmallPad.width||e<i.settings.SmallPad.height),s!==this._fast_drawing&&this.showPadButtons()}isGrayscale(){return!1}setGrayscale(){console.error("grayscale mode not implemented for RCanvas")}createCanvasSvg(t,e){let s,a,n=null,h=null,o=null;if(t>0){if(this._fixed_size)return t>1;if(h=this.getCanvSvg(),h.empty())return!1;if(n=h.property("height_factor"),o=this.testMainResize(t,null,n),!o.changed&&1===t)return!1;this.isBatchMode()||(s=this.getLayerSvg("btns_layer",this.this_pad_name)),a=h.selectChild(".canvas_fillrect")}else{const t=this.selectDom();"static"===t.style("position")&&t.style("position","relative"),h=t.append("svg").attr("class","jsroot root_canvas").property("pad_painter",this).property("current_pad","").property("redraw_by_resize",!1),this.setTopPainter(),this.isBatchMode()||this.online_canvas||h.append("svg:title").text("ROOT canvas"),a=h.append("svg:path").attr("class","canvas_fillrect"),this.isBatchMode()||a.style("pointer-events","visibleFill").on("dblclick",(t=>this.enlargePad(t,!0))).on("click",(()=>this.selectObjectPainter(this,null))).on("mouseenter",(()=>this.showObjectStatus())).on("contextmenu",i.settings.ContextMenu?t=>this.padContextMenu(t):null),h.append("svg:g").attr("class","primitives_layer"),h.append("svg:g").attr("class","info_layer"),this.isBatchMode()||(s=h.append("svg:g").attr("class","btns_layer").property("leftside","left"===i.settings.ToolBarSide).property("vertical",i.settings.ToolBarVert)),n=.66,this.pad&&this.pad.fWinSize[0]&&this.pad.fWinSize[1]&&(n=this.pad.fWinSize[1]/this.pad.fWinSize[0],(n<.1||n>10)&&(n=.66)),this._fixed_size?(t.style("overflow","auto"),o={width:this.pad.fWinSize[0],height:this.pad.fWinSize[1]},o.width&&o.height||(o=(0,r.xh)(t))):o=this.testMainResize(2,e,n)}return this.createAttFill({pattern:1001,color:0}),o.width<=5||o.height<=5?(h.style("display","none"),console.warn(`Hide canvas while geometry too small w=${o.width} h=${o.height}`),o.width=200,o.height=100):h.style("display",null),this._fixed_size?h.attr("x",0).attr("y",0).attr("width",o.width).attr("height",o.height).style("position","absolute"):h.attr("x",0).attr("y",0).style("width","100%").style("height","100%").style("position","absolute").style("left",0).style("top",0).style("bottom",0).style("right",0),h.style("filter",i.settings.DarkMode?"invert(100%)":null),h.attr("viewBox",`0 0 ${o.width} ${o.height}`).attr("preserveAspectRatio","none").property("height_factor",n).property("draw_x",0).property("draw_y",0).property("draw_width",o.width).property("draw_height",o.height),this._pad_x=0,this._pad_y=0,this._pad_width=o.width,this._pad_height=o.height,a.attr("d",`M0,0H${o.width}V${o.height}H0Z`).call(this.fillatt.func),this.setFastDrawing(o.width,o.height),this.alignButtons&&s&&this.alignButtons(s,o.width,o.height),!0}drawItemNameOnCanvas(){}enlargePad(t,e,s){if(t?.preventDefault(),t?.stopPropagation(),e&&this._websocket&&"off"===this.enlargeMain("state"))return;const i=this.getCanvSvg(),a=i.property("pad_enlarged");if(!this.iscan&&this.has_canvas&&(a||this.hasObjectsToDraw()||this.painters))a||s?a===this.pad?(this.enlargeMain(!1),i.property("pad_enlarged",null)):!s&&e&&console.error("missmatch with pad double click events"):(this.enlargeMain(!0,!0),i.property("pad_enlarged",this.pad),(0,o.QD)({pp:this,active:!0}));else{if(this._fixed_size)return;if(!this.enlargeMain(!s&&"toggle"))return;"off"===this.enlargeMain("state")?i.property("pad_enlarged",null):(0,o.QD)({pp:this,active:!0})}return this.checkResize(!0)}createPadSvg(t){if(!this.has_canvas)return this.createCanvasSvg(t?2:0),!0;const e=this.getPadSvg(this.pad_name),s=this.getCanvSvg(),a=e.property("draw_width"),n=e.property("draw_height"),h=s.property("pad_enlarged");let r=!0,o=a,l=n,d=0,c=0,g=null,m=null,u=null;return this.pad?.fPos&&this.pad?.fSize&&(d=Math.round(a*this.pad.fPos.fHoriz.fArr[0]),c=Math.round(n*this.pad.fPos.fVert.fArr[0]),o=Math.round(a*this.pad.fSize.fHoriz.fArr[0]),l=Math.round(n*this.pad.fSize.fVert.fArr[0])),h&&(r=!1,h===this.pad?r=!0:this.forEachPainterInPad((t=>{t.getObject()===h&&(r=!0)}),"pads"),r&&(o=a,l=n,d=c=0)),t?(g=this.svg_this_pad(),m=g.selectChild(".root_pad_border"),this.isBatchMode()||(u=this.getLayerSvg("btns_layer",this.this_pad_name)),this.addPadInteractive(!0)):(g=e.selectChild(".primitives_layer").append("svg:svg").classed("__root_pad_"+this.this_pad_name,!0).attr("pad",this.this_pad_name).property("pad_painter",this),this.isBatchMode()||g.append("svg:title").text("ROOT subpad"),m=g.append("svg:path").attr("class","root_pad_border"),g.append("svg:g").attr("class","primitives_layer"),this.isBatchMode()||(u=g.append("svg:g").attr("class","btns_layer").property("leftside","left"!==i.settings.ToolBarSide).property("vertical",i.settings.ToolBarVert)),i.settings.ContextMenu&&m.on("contextmenu",(t=>this.padContextMenu(t))),this.isBatchMode()||m.style("pointer-events","visibleFill").on("dblclick",(t=>this.enlargePad(t,!0))).on("click",(()=>this.selectObjectPainter(this,null))).on("mouseenter",(()=>this.showObjectStatus()))),this.createAttFill({attr:this.pad}),this.createAttLine({attr:this.pad,color0:0===this.pad.fBorderMode?"none":""}),g.style("display",r?null:"none").attr("viewBox",`0 0 ${o} ${l}`).attr("preserveAspectRatio","none").attr("x",d).attr("y",c).attr("width",o).attr("height",l).property("draw_x",d).property("draw_y",c).property("draw_width",o).property("draw_height",l),this._pad_x=d,this._pad_y=c,this._pad_width=o,this._pad_height=l,m.attr("d",`M0,0H${o}V${l}H0Z`).call(this.fillatt.func).call(this.lineatt.func),this.setFastDrawing(o,l),g.property("can3d")===i.constants.Embed3D.Overlay&&this.selectDom().select(".draw3d_"+this.this_pad_name).style("display",r?"":"none"),this.alignButtons&&u&&this.alignButtons(u,o,l),r}addPadInteractive(){(0,i.isFunc)(this.$userInteractive)&&(this.$userInteractive(),delete this.$userInteractive)}hasObjectsToDraw(){return this.pad?.fPrimitives?.find((t=>t._typename!==`${i.nsREX}RPadDisplayItem`))}syncDraw(t){const e={kind:t||"redraw"};return void 0===this._doing_draw?(this._doing_draw=[e],Promise.resolve(!0)):!(!0!==e.kind&&this._doing_draw.findIndex(((t,s)=>s>0&&t.kind===e.kind))>0)&&(this._doing_draw.push(e),new Promise((t=>{e.func=t})))}confirmDraw(){if(void 0===this._doing_draw)return console.warn("failure, should not happen");if(this._doing_draw.shift(),0===this._doing_draw.length)delete this._doing_draw;else{const t=this._doing_draw[0];t.func&&(t.func(),delete t.func)}}async drawObject(){return console.log("Not possible to draw object without loading of draw.mjs"),null}async drawPrimitives(t){if(void 0===t)return this.iscan&&(this._start_tm=(new Date).getTime()),this._num_primitives=this.pad?.fPrimitives?.length??0,this.syncDraw(!0).then((()=>this.drawPrimitives(0)));if(this.pad&&!(t>=this._num_primitives))return this.drawObject(this.getDom(),this.pad.fPrimitives[t],"").then((e=>((0,i.isObject)(e)&&(e._primitive=!0),this.drawPrimitives(t+1))));if(this.confirmDraw(),this._start_tm){const t=(new Date).getTime()-this._start_tm;t>3e3&&console.log(`Canvas drawing took ${(.001*t).toFixed(2)}s`),delete this._start_tm}}processPadTooltipEvent(t){const e=[],s=[];return this.painters?.forEach((t=>{(0,i.isFunc)(t.processTooltipEvent)&&e.push(t)})),t&&(t.nproc=e.length),e.forEach((e=>{const i=e.processTooltipEvent(t)||{user_info:null};s.push(i),t?.painters&&(i.painter=e)})),s}changeDarkMode(t){this.getCanvSvg().style("filter",t??i.settings.DarkMode?"invert(100%)":null)}fillContextMenu(t){this.iscan?t.add("header: RCanvas"):t.add("header: RPad"),t.addchk(this.isTooltipAllowed(),"Show tooltips",(()=>this.setTooltipAllowed("toggle"))),this._websocket||(t.addAttributesMenu(this),this.iscan&&t.addSettingsMenu(!1,!1,(t=>{"dark"===t&&this.changeDarkMode()}))),t.add("separator"),(0,i.isFunc)(this.hasMenuBar)&&(0,i.isFunc)(this.actiavteMenuBar)&&t.addchk(this.hasMenuBar(),"Menu bar",(t=>this.actiavteMenuBar(t))),(0,i.isFunc)(this.hasEventStatus)&&(0,i.isFunc)(this.activateStatusBar)&&(0,i.isFunc)(this.canStatusBar)&&this.canStatusBar()&&t.addchk(this.hasEventStatus(),"Event status",(()=>this.activateStatusBar("toggle"))),(this.enlargeMain()||this.has_canvas&&this.hasObjectsToDraw())&&t.addchk("on"===this.enlargeMain("state"),"Enlarge "+(this.iscan?"canvas":"pad"),(()=>this.enlargePad()));const e=this.this_pad_name||(this.iscan?"canvas":"pad");return t.add("sub:Save as"),["svg","png","jpeg","pdf","webp"].forEach((s=>t.add(`${e}.${s}`,(()=>this.saveAs(s,this.iscan,`${e}.${s}`))))),t.add("endsub:"),!0}padContextMenu(t){t.stopPropagation&&(t.stopPropagation(),t.preventDefault(),this.getFramePainter()?.setLastEventPos()),(0,f.ES)(t,this).then((t=>(this.fillContextMenu(t),this.fillObjectExecMenu(t)))).then((t=>t.show()))}async redrawPad(t){const e=this.syncDraw(t);if(!1===e)return console.log("Prevent RPad redrawing"),!1;let s=!0;const a=e=>{for(;e<this.painters.length;){const n=this.painters[e++];let h=0;if((s||n.this_pad_name)&&(h=n.redraw(t)),(0,i.isPromise)(h))return h.then((()=>a(e)))}return!0};return e.then((()=>(this.iscan?this.createCanvasSvg(2):s=this.createPadSvg(!0),a(0)))).then((()=>(this.addPadInteractive(),(0,o.OZ)()===this&&this.getCanvPainter()?.producePadEvent("padredraw",this),this.confirmDraw(),!0)))}redraw(t){return this.redrawPad(t)}needRedrawByResize(){const t=this.svg_this_pad();if(!t.empty()&&t.property("can3d")===i.constants.Embed3D.Overlay)return!0;for(let e=0;e<this.painters.length;++e)if((0,i.isFunc)(this.painters[e].needRedrawByResize)&&this.painters[e].needRedrawByResize())return!0;return!1}checkCanvasResize(t,e){if(this._ignore_resize)return!1;if(!this.iscan&&this.has_canvas)return!1;const s=this.syncDraw("canvas_resize");if(!1===s)return!1;!0!==t&&!1!==t||(e=t,t=null),(0,i.isObject)(t)&&t.force&&(e=!0),e||(e=this.needRedrawByResize());let a=!1;const n=t=>!a||t>=this.painters.length?(this.confirmDraw(),a):(0,i.getPromise)(this.painters[t].redraw(e?"redraw":"resize")).then((()=>n(t+1)));return s.then((()=>(a=this.createCanvasSvg(e?2:1,t),a&&this.iscan&&this.pad&&this.online_canvas&&!this.embed_canvas&&!this.isBatchMode()&&(this._resize_tmout&&clearTimeout(this._resize_tmout),this._resize_tmout=setTimeout((()=>{if(delete this._resize_tmout,!this.pad?.fWinSize)return;const t=this.getPadWidth(),e=this.getPadHeight();t>0&&e>0&&(this.pad.fWinSize[0]!==t||this.pad.fWinSize[1]!==e)&&(this.pad.fWinSize[0]=t,this.pad.fWinSize[1]=e,this.sendWebsocket(`RESIZED:[${t},${e}]`))}),1e3)),n(0))))}updateObject(t){return!!t&&(this.pad.fStyle=t.fStyle,this.pad.fAttr=t.fAttr,this.iscan?(this.pad.fTitle=t.fTitle,this.pad.fWinSize=t.fWinSize):(this.pad.fPos=t.fPos,this.pad.fSize=t.fSize),!0)}addObjectPainter(t,e,s){t&&e&&e[s]&&void 0===t.snapid&&(this.painters.indexOf(t)<0&&this.painters.push(t),t.assignSnapId(e[s].fObjectID),t.rstyle||(t.rstyle=e[s].fStyle||this.rstyle))}extractTObjectProp(t){if(t.fColIndex&&t.fColValue){const e=this.root_colors||(0,_.HG)();for(let s=0;s<t.fColIndex.length;++s)e[t.fColIndex[s]]=t.fColValue[s]}const e=new l.D,s=t.fObject;e.assignObject(t),e.csstype=t.fCssType,e.rstyle=t.fStyle,t.fOption=e.v7EvalAttr("options","");const i=(t,i)=>{const a=e.v7EvalColor(i,"");a&&(s[t]=(0,_.nM)(a,this.root_colors))};void 0!==s.fLineColor&&void 0!==s.fLineWidth&&void 0!==s.fLineStyle&&(i("fLineColor","line_color"),s.fLineWidth=e.v7EvalAttr("line_width",s.fLineWidth),s.fLineStyle=e.v7EvalAttr("line_style",s.fLineStyle)),void 0!==s.fFillColor&&void 0!==s.fFillStyle&&(i("fFillColor","fill_color"),s.fFillStyle=e.v7EvalAttr("fill_style",s.fFillStyle)),void 0!==s.fMarkerColor&&void 0!==s.fMarkerStyle&&void 0!==s.fMarkerSize&&(i("fMarkerColor","marker_color"),s.fMarkerStyle=e.v7EvalAttr("marker_style",s.fMarkerStyle),s.fMarkerSize=e.v7EvalAttr("marker_size",s.fMarkerSize)),void 0!==s.fTextColor&&void 0!==s.fTextAlign&&void 0!==s.fTextAngle&&void 0!==s.fTextSize&&(i("fTextColor","text_color"),s.fTextAlign=e.v7EvalAttr("text_align",s.fTextAlign),s.fTextAngle=e.v7EvalAttr("text_angle",s.fTextAngle),s.fTextSize=e.v7EvalAttr("text_size",s.fTextSize))}async drawNextSnap(t,e){if(void 0===e&&(e=-1,this._snaps_map={},this._num_primitives=t?t.length:0,this._auto_color_cnt=0),delete this.next_rstyle,++e,!t||e>=t.length)return delete this._snaps_map,delete this._auto_color_cnt,this;const s=t[e],a=s.fObjectID;let n=this._snaps_map[a],h=null;if(n?n++:n=1,this._snaps_map[a]=n,s.fDummy)return this.drawNextSnap(t,e);for(let i=0;i<this.painters.length;++i)if(this.painters[i].snapid===a&&0===--n){h=this.painters[i];break}if(h){if(s._typename===`${i.nsREX}RPadDisplayItem`)return h.redrawPadSnap(s).then((s=>(this.addObjectPainter(s,t,e),this.drawNextSnap(t,e))));let a;return s._typename===`${i.nsREX}TObjectDisplayItem`&&this.extractTObjectProp(s),h.updateObject(s.fDrawable||s.fObject||s,s.fOption||"",!0)&&(a=h.redraw()),(0,i.getPromise)(a).then((()=>this.drawNextSnap(t,e)))}if(s._typename===`${i.nsREX}RPadDisplayItem`){const i=s,a=new x(this.getDom(),i,!1);a.decodeOptions(""),a.addToPadPrimitives(this.this_pad_name),a.assignSnapId(s.fObjectID),a.rstyle=s.fStyle,a.createPadSvg(),s.fPrimitives&&s.fPrimitives.length>0&&a.addPadButtons();const n=a.selectCurrentPad(a.this_pad_name);return a.drawNextSnap(s.fPrimitives).then((()=>(a.addPadInteractive(),a.selectCurrentPad(n),this.drawNextSnap(t,e))))}if(this.next_rstyle=t[e].fStyle||this.rstyle,s._typename===`${i.nsREX}TObjectDisplayItem`){const a={kNone:0,kObject:1,kColors:4,kStyle:5,kPalette:6};if(s.fKind===a.kStyle)return Object.assign(i.gStyle,s.fObject),this.drawNextSnap(t,e);if(s.fKind===a.kColors){const i=[],a=s.fObject.arr;for(let t=0;t<a.length;++t){const e=a[t].fString,s=e.indexOf("=");s>0&&(i[parseInt(e.slice(0,s))]=e.slice(s+1))}return this.root_colors=i,this.drawNextSnap(t,e)}if(s.fKind===a.kPalette){const i=s.fObject.arr,a=[];for(let t=0;t<i.length;++t)a[t]=i[t].fString;return this.custom_palette=new _.rE(a),this.drawNextSnap(t,e)}if(!this.getFramePainter())return this.drawObject(this.getDom(),{_typename:i.clTFrame,$dummy:!0},"").then((()=>this.drawNextSnap(t,e-1)));this.extractTObjectProp(s)}return this.drawObject(this.getDom(),s.fDrawable||s.fObject||s,s.fOption||"").then((s=>(this.addObjectPainter(s,t,e),this.drawNextSnap(t,e))))}findSnap(t,e){function s(s){return!(!s||!(0,i.isStr)(s))&&(s===t||e&&s.length>t.length&&s.indexOf(t)===s.length-t.length)}if(s(this.snapid))return this;if(!this.painters)return null;for(let a=0;a<this.painters.length;++a){let n=this.painters[a];if(!e&&(0,i.isFunc)(n.findSnap)?n=n.findSnap(t):s(n.snapid)||(n=null),n)return n}return null}async redrawPadSnap(t){if(!t||!t.fPrimitives)return this;if(this.iscan&&this._websocket&&t.fTitle&&!this.embed_canvas&&"undefined"!==typeof document&&(document.title=t.fTitle),void 0===this.snapid){this.assignSnapId(t.fObjectID),this.draw_object=t,this.pad=t,this.isBatchMode()&&this.iscan&&(this._fixed_size=!0);const e=this.selectDom().attr("id");return this.isBatchMode()||this.use_openui||this.brlayout||!e||!(0,i.isStr)(e)||(this.brlayout=new h.jX(e,null,this),this.brlayout.create(e,!0),this.setDom(this.brlayout.drawing_divid()),(0,n.d7)(this.brlayout)),this.createCanvasSvg(0),this.addPadButtons(!0),this.drawNextSnap(t.fPrimitives)}this.updateObject(t),this.iscan?this.createCanvasSvg(2):this.createPadSvg(!0);let e=!1,s=!1;for(let i=0;i<this.painters.length;++i){let a=this.painters[i];void 0!==a.snapid&&(t.fPrimitives.forEach((t=>{a&&t.fObjectID===a.snapid&&(a=null,e=!0)})),a&&(this.painters.splice(i--,1),a.cleanup(),s=!0,this.main_painter_ref===a&&delete this.main_painter_ref))}if(s&&delete this.pads_cache,!e){let t=this.getFramePainter();t?.is_root6()&&(t=null);for(let e=0;e<this.painters.length;++e)t!==this.painters[e]&&this.painters[e].cleanup();this.painters=[],delete this.main_painter_ref,t&&(this.painters.push(t),t.cleanFrameDrawings(),t.redraw()),(0,i.isFunc)(this.removePadButtons)&&this.removePadButtons(),this.addPadButtons(!0)}const a=this.selectCurrentPad(this.this_pad_name);return this.drawNextSnap(t.fPrimitives).then((()=>(this.addPadInteractive(),this.selectCurrentPad(a),(0,o.OZ)()===this&&this.getCanvPainter()?.producePadEvent("padredraw",this),this)))}async createImage(t){return"png"===t||"jpeg"===t||"svg"===t||"pdf"===t?this.produceImage(!0,t).then((e=>{if(!e||"svg"===t)return e;const s=e.indexOf("base64,");return s>0?e.slice(s+7):""})):""}itemContextMenu(t){const e=this.svg_this_pad().node().getBoundingClientRect(),s={clientX:e.left+10,clientY:e.top+10};if("pad"===t)return(0,i.postponePromise)((()=>this.padContextMenu(s)),50);let a,n=null;switch(t){case"xaxis":case"yaxis":case"zaxis":n=this.getMainPainter(),a=t[0];break;case"frame":n=this.getFramePainter();break;default:{const e=parseInt(t);Number.isInteger(e)&&(n=this.painters[e])}}return(0,i.isFunc)(n?.fillContextMenu)?(0,f.ES)(s,n).then((t=>{(n.fillContextMenu(t,a)||n.snapid)&&n.fillObjectExecMenu(t,a).then((()=>(0,i.postponePromise)((()=>t.show()),50)))})):void 0}saveAs(t,e,s){s||(s=(this.this_pad_name||(this.iscan?"canvas":"pad"))+"."+t),this.produceImage(e,t).then((e=>{if(!e)return console.error(`Fail to produce image ${s}`);(0,n.OJ)(s,"svg"!==t?e:"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e))}))}findActivePad(){return null}async produceImage(t,e){const s="frame"===t,a=s?this.getFrameSvg(this.this_pad_name):t?this.getCanvSvg():this.svg_this_pad(),n=t&&!s?this.getCanvPainter():this,h=[];if(a.empty())return"";if(s||!t){const t=this.getCanvSvg().selectChild(".canvas_defs");t.empty()||(h.push({prnt:this.getCanvSvg(),defs:t}),a.node().insertBefore(t.node(),a.node().firstChild))}s||n.forEachPainterInPad((t=>{const e={prnt:t.svg_this_pad()};h.push(e);const s=t.getLayerSvg("btns_layer",this.this_pad_name);e.btns_node=s.node(),e.btns_node&&(e.btns_prnt=e.btns_node.parentNode,e.btns_next=e.btns_node.nextSibling,s.remove());const a=t.getFramePainter();if(!(0,i.isFunc)(a?.render3D)||!(0,i.isFunc)(a?.access3dKind))return;const n=a.access3dKind();if(n!==i.constants.Embed3D.Overlay&&n!==i.constants.Embed3D.Embed)return;const r=a.getSizeFor3d(i.constants.Embed3D.Embed),o=a.renderer.domElement;a.render3D(0);const l=o.toDataURL("image/png");n===i.constants.Embed3D.Embed&&(e.foreign=e.prnt.select("."+r.clname),e.foreign.remove());const d=a.getFrameSvg();e.frame_node=d.node(),e.frame_node&&(e.frame_next=e.frame_node.nextSibling,d.remove()),e.img=e.prnt.insert("image",".primitives_layer").attr("x",r.x).attr("y",r.y).attr("width",o.width).attr("height",o.height).attr("href",l)}),"pads");let o=a.property("draw_width"),l=a.property("draw_height");if(s){const t=this.getFramePainter();o=t.getFrameWidth(),l=t.getFrameHeight()}const d="pdf"===e?{node:a.node(),width:o,height:l,reset_tranform:s}:(0,r.NM)(`<svg width="${o}" height="${l}" xmlns="http://www.w3.org/2000/svg">${a.node().innerHTML}</svg>`);return(0,r.Vm)(d,e).then((t=>{for(let e=0;e<h.length;++e){const t=h[e];t.img?.remove();const s=t.prnt.selectChild(".primitives_layer");t.foreign&&t.prnt.node().insertBefore(t.foreign.node(),s.node()),t.frame_node&&s.node().insertBefore(t.frame_node,t.frame_next),t.btns_node&&t.btns_prnt.insertBefore(t.btns_node,t.btns_next),t.defs&&t.prnt.node().insertBefore(t.defs.node(),t.prnt.node().firstChild)}return t}))}clickPadButton(t,e){if("CanvasSnapShot"===t)return this.saveAs("png",!0);if("enlargePad"===t)return this.enlargePad();if("PadSnapShot"===t)return this.saveAs("png",!1);if("PadContextMenus"===t){if(e?.preventDefault(),e?.stopPropagation(),(0,f.IV)())return;return(0,f.ES)(e,this).then((t=>{t.add("header:Menus"),this.iscan?t.add("Canvas","pad",this.itemContextMenu):t.add("Pad","pad",this.itemContextMenu),this.getFramePainter()&&t.add("Frame","frame",this.itemContextMenu);const e=this.getMainPainter();if(e&&(t.add("X axis","xaxis",this.itemContextMenu),t.add("Y axis","yaxis",this.itemContextMenu),(0,i.isFunc)(e.getDimension)&&e.getDimension()>1&&t.add("Z axis","zaxis",this.itemContextMenu)),this.painters?.length){t.add("separator");const e=[];this.painters.forEach(((s,a)=>{const n=s?.getObject();if(!n||e.indexOf(n)>=0||s.isSecondary())return;let h=(0,i.isFunc)(s.getClassName)?s.getClassName():n._typename||"";h&&(h+="::"),h+=(0,i.isFunc)(s.getObjectName)?s.getObjectName():n.fName||`item${a}`,t.add(h,a,this.itemContextMenu),e.push(n)}))}t.show()}))}let s=!1;const a=[];for(let n=0;n<this.painters.length;++n){const h=this.painters[n];(0,i.isFunc)(h.clickPadButton)&&a.push(h.clickPadButton(t,e)),!s&&(0,i.isFunc)(h.clickButton)&&(s=h.clickButton(t),(0,i.isPromise)(s)&&a.push(s))}return Promise.all(a)}addPadButton(t,e,s,a){if(!i.settings.ToolBar||this.isBatchMode())return;this._buttons||(this._buttons=[]);for(let i=0;i<this._buttons.length;++i)if(this._buttons[i].funcname===s)return;this._buttons.push({btn:t,tooltip:e,funcname:s,keyname:a});if(!(this.iscan||!this.has_canvas)&&0!==s.indexOf("Pad")&&"enlargePad"!==s){const i=this.getCanvPainter();i&&i!==this&&i.addPadButton(t,e,s)}}addPadButtons(t){this.addPadButton("camera","Create PNG",this.iscan?"CanvasSnapShot":"PadSnapShot","Ctrl PrintScreen"),i.settings.ContextMenu&&this.addPadButton("question","Access context menus","PadContextMenus");(!this.iscan&&this.has_canvas&&this.hasObjectsToDraw()||this.enlargeMain("verify"))&&this.addPadButton("circle","Enlarge canvas","enlargePad"),t&&this.brlayout&&(this.addPadButton("diamand","Toggle Ged","ToggleGed"),this.addPadButton("three_circles","Toggle Status","ToggleStatus"))}showPadButtons(){this._buttons&&(p.DR.assign(this),this.showPadButtons())}getPadLength(t,e,s){let i,a;const n=t?-1:1,h=(t,s)=>t<e.fArr.length?e.fArr[t]:s,r=()=>(i||(i=s?s.getFrameRect():this.getPadRect()),i);if(s){const e=h(2),i=t?"gry":"grx";void 0!==e&&s[i]&&(a=s[i](e))}void 0===a&&(a=t?r().height:0);const o=h(0,0);return a+=n*h(1,0),o&&(a+=n*(t?r().height:r().width)*o),Math.round(a)}getCoordinate(t,e){return{x:this.getPadLength(!1,t.fHoriz,e),y:this.getPadLength(!0,t.fVert,e)}}decodeOptions(t){const e=this.getObject();if(!e)return;const s=new r.nC(t);this.options||(this.options={}),Object.assign(this.options,{GlobalColors:!0,LocalColors:!1,IgnorePalette:!1,RotateFrame:!1,FixFrame:!1}),(s.check("NOCOLORS")||s.check("NOCOL"))&&(this.options.GlobalColors=this.options.LocalColors=!1),(s.check("LCOLORS")||s.check("LCOL"))&&(this.options.GlobalColors=!1,this.options.LocalColors=!0),(s.check("NOPALETTE")||s.check("NOPAL"))&&(this.options.IgnorePalette=!0),s.check("ROTATE")&&(this.options.RotateFrame=!0),s.check("FIXFRAME")&&(this.options.FixFrame=!0),s.check("WHITE")&&(e.fFillColor=0),s.check("LOGX")&&(e.fLogx=1),s.check("LOGY")&&(e.fLogy=1),s.check("LOGZ")&&(e.fLogz=1),s.check("LOG")&&(e.fLogx=e.fLogy=e.fLogz=1),s.check("GRIDX")&&(e.fGridx=1),s.check("GRIDY")&&(e.fGridy=1),s.check("GRID")&&(e.fGridx=e.fGridy=1),s.check("TICKX")&&(e.fTickx=1),s.check("TICKY")&&(e.fTicky=1),s.check("TICK")&&(e.fTickx=e.fTicky=1)}static async draw(t,e,s){const a=new x(t,e,!1);a.decodeOptions(s),a.getCanvSvg().empty()?(a.has_canvas=!1,a.this_pad_name="",a.setTopPainter()):a.addToPadPrimitives(a.pad_name),a.createPadSvg(),!a.matchObjectType(i.clTPad)||a.has_canvas&&!a.hasObjectsToDraw()||a.addPadButtons();const n=a.has_canvas?a.selectCurrentPad(a.this_pad_name):void 0;return(0,o.QD)({pp:a,active:!1}),a.drawPrimitives().then((()=>(a.addPadInteractive(),a.showPadButtons(),a.selectCurrentPad(n),a)))}}const v="0123456789abcdef".split(""),y=[-2147483648,8388608,32768,128],w=[24,16,8,0],b=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];class k{constructor(t){this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=t}update(t){if(this.finalized)return;const e="string"!==typeof t,s=t.length,i=this.blocks;let a,n,h=0;for(;h<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(n=this.start;h<s&&n<64;++h)i[n>>2]|=t[h]<<w[3&n++];else for(n=this.start;h<s&&n<64;++h)a=t.charCodeAt(h),a<128?i[n>>2]|=a<<w[3&n++]:a<2048?(i[n>>2]|=(192|a>>6)<<w[3&n++],i[n>>2]|=(128|63&a)<<w[3&n++]):a<55296||a>=57344?(i[n>>2]|=(224|a>>12)<<w[3&n++],i[n>>2]|=(128|a>>6&63)<<w[3&n++],i[n>>2]|=(128|63&a)<<w[3&n++]):(a=65536+((1023&a)<<10|1023&t.charCodeAt(++h)),i[n>>2]|=(240|a>>18)<<w[3&n++],i[n>>2]|=(128|a>>12&63)<<w[3&n++],i[n>>2]|=(128|a>>6&63)<<w[3&n++],i[n>>2]|=(128|63&a)<<w[3&n++]);this.lastByteIndex=n,this.bytes+=n-this.start,n>=64?(this.block=i[16],this.start=n-64,this.hash(),this.hashed=!0):this.start=n}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}finalize(){if(this.finalized)return;this.finalized=!0;const t=this.blocks,e=this.lastByteIndex;t[16]=this.block,t[e>>2]|=y[3&e],this.block=t[16],e>=56&&(this.hashed||this.hash(),t[0]=this.block,t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.hBytes<<3|this.bytes>>>29,t[15]=this.bytes<<3,this.hash()}hash(){const t=this.blocks;let e,s,i,a,n,h,r,o,l,d,c,g=this.h0,m=this.h1,u=this.h2,_=this.h3,f=this.h4,p=this.h5,x=this.h6,v=this.h7;for(e=16;e<64;++e)n=t[e-15],s=(n>>>7|n<<25)^(n>>>18|n<<14)^n>>>3,n=t[e-2],i=(n>>>17|n<<15)^(n>>>19|n<<13)^n>>>10,t[e]=t[e-16]+s+t[e-7]+i|0;for(c=m&u,e=0;e<64;e+=4)this.first?(this.is224?(o=300032,n=t[0]-1413257819,v=n-150054599|0,_=n+24177077|0):(o=704751109,n=t[0]-210244248,v=n-1521486534|0,_=n+143694565|0),this.first=!1):(s=(g>>>2|g<<30)^(g>>>13|g<<19)^(g>>>22|g<<10),i=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7),o=g&m,a=o^g&u^c,r=f&p^~f&x,n=v+i+r+b[e]+t[e],h=s+a,v=_+n|0,_=n+h|0),s=(_>>>2|_<<30)^(_>>>13|_<<19)^(_>>>22|_<<10),i=(v>>>6|v<<26)^(v>>>11|v<<21)^(v>>>25|v<<7),l=_&g,a=l^_&m^o,r=v&f^~v&p,n=x+i+r+b[e+1]+t[e+1],h=s+a,x=u+n|0,u=n+h|0,s=(u>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),i=(x>>>6|x<<26)^(x>>>11|x<<21)^(x>>>25|x<<7),d=u&_,a=d^u&g^l,r=x&v^~x&f,n=p+i+r+b[e+2]+t[e+2],h=s+a,p=m+n|0,m=n+h|0,s=(m>>>2|m<<30)^(m>>>13|m<<19)^(m>>>22|m<<10),i=(p>>>6|p<<26)^(p>>>11|p<<21)^(p>>>25|p<<7),c=m&u,a=c^m&_^d,r=p&x^~p&v,n=f+i+r+b[e+3]+t[e+3],h=s+a,f=g+n|0,g=n+h|0,this.chromeBugWorkAround=!0;this.h0=this.h0+g|0,this.h1=this.h1+m|0,this.h2=this.h2+u|0,this.h3=this.h3+_|0,this.h4=this.h4+f|0,this.h5=this.h5+p|0,this.h6=this.h6+x|0,this.h7=this.h7+v|0}digest(){this.finalize();const t=this.h0,e=this.h1,s=this.h2,i=this.h3,a=this.h4,n=this.h5,h=this.h6,r=this.h7,o=[t>>24&255,t>>16&255,t>>8&255,255&t,e>>24&255,e>>16&255,e>>8&255,255&e,s>>24&255,s>>16&255,s>>8&255,255&s,i>>24&255,i>>16&255,i>>8&255,255&i,a>>24&255,a>>16&255,a>>8&255,255&a,n>>24&255,n>>16&255,n>>8&255,255&n,h>>24&255,h>>16&255,h>>8&255,255&h];return this.is224||o.push(r>>24&255,r>>16&255,r>>8&255,255&r),o}hex(){const t=this.digest();let e="";for(let s=0;s<t.length;++s)e+=v[t[s]>>4&15]+v[15&t[s]];return e}toString(){return this.hex()}}function P(t,e,s){const i=new k(!1);return i.update(t),i.update(e),s?i.hex():i.digest()}let z="";function C(t,e,s){const i=function(t,e){const s=new k(!1);return s.update(t),e?s.hex():s.digest()}(z+t),a=[],n=[];for(;i.length<64;)i.push(0);for(let r=0;r<i.length;++r){const t=i[r];a.push(92^t),n.push(54^t)}const h=P(n,void 0===s?e:new Uint8Array(e,s));return P(a,h,!0)}class S{constructor(t,e,s,i){this.path=t,this.connid=null,this.req=null,this.raw=e,this.handle=s,this.counter=i,this.nextRequest("","connect")}nextRequest(t,e){let s=this.path,a="buf",n=null;if("connect"===e)s+=this.raw?"?raw_connect":"?txt_connect",this.handle&&(s+="&"+this.handle.getConnArgs(this.counter++)),console.log(`longpoll connect ${s} raw = ${this.raw}`),this.connid="connect";else if("close"===e){if(null===this.connid||"close"===this.connid)return;s+=`?connection=${this.connid}&close`,this.handle&&(s+="&"+this.handle.getConnArgs(this.counter++)),this.connid="close",a="text;sync"}else null===this.connid||"number"!==typeof this.connid?i.browser.qt5||console.error("No connection"):(s+="?connection="+this.connid,this.handle&&(s+="&"+this.handle.getConnArgs(this.counter++)),"dummy"===e&&(s+="&dummy"));t&&(this.raw?s+="&post="+(0,i.btoa_func)(t):(a="postbuf",n=t)),(0,i.createHttpRequest)(s,a,(function(t){if(this.handle.req===this&&(this.handle.req=null),null===t)return this.handle.processRequest(null);if(this.handle.raw){const e=new Uint8Array(t);let s="",a=0,n=e.length;if(n<4)return i.browser.qt5||console.error(`longpoll got short message in raw mode ${n}`),this.handle.processRequest(null);for(;a<4;)s+=String.fromCharCode(e[a++]);if("txt:"!==s){for(s="";a<n&&":"!==String.fromCharCode(e[a]);)s+=String.fromCharCode(e[a++]);++a,n=a+parseInt(s.trim())}for(s="";a<n;)s+=String.fromCharCode(e[a++]);s&&("<<nope>>"===s?this.handle.processRequest(-1111):this.handle.processRequest(s)),n<e.length&&this.handle.processRequest(t,n)}else if("application/x-binary"===this.getResponseHeader("Content-Type")){const e=this.getResponseHeader("LongpollHeader");e&&this.handle.processRequest(e),this.handle.processRequest(t,0)}else{if(t&&!(0,i.isStr)(t)){let e="";const s=new Uint8Array(t);for(let t=0;t<s.length;++t)e+=String.fromCharCode(s[t]);t=e}"<<nope>>"===t?this.handle.processRequest(-1111):this.handle.processRequest(t)}}),(function(){this.handle.processRequest(null,"error")}),!0).then((t=>{t.handle=this,this.req||(this.req=t),t.send(n)}))}processRequest(t,e){if(null===t)return(0,i.isFunc)(this.onerror)&&this.onerror("receive data with connid "+(this.connid||"---")),"error"===e&&(0,i.isFunc)(this.onclose)&&this.onclose("force_close"),void(this.connid=null);-1111===t&&(t="");let s=5;if("connect"===this.connid){if(!t)return this.connid=null,void((0,i.isFunc)(this.onerror)&&this.onerror("connection rejected"));this.connid=parseInt(t),s=100,console.log(`Get new longpoll connection with id ${this.connid}`),(0,i.isFunc)(this.onopen)&&this.onopen()}else{if("close"===this.connid)return void((0,i.isFunc)(this.onclose)&&this.onclose());(0,i.isFunc)(this.onmessage)&&t&&this.onmessage({data:t,offset:e})}this.req||setTimeout((()=>{this.req||this.nextRequest("","dummy")}),s)}send(t){this.nextRequest(t)}close(){this.nextRequest("","close")}}class A{constructor(t){this.receiver=t,this.protocol=[],this.cnt=0,(0,i.httpRequest)("protocol.json","text").then((t=>this.getProtocol(t)))}getProtocol(t){t&&(this.protocol=JSON.parse(t),(0,i.isFunc)(this.onopen)&&this.onopen(),this.nextOperation())}send(){"send"===this.protocol[this.cnt]&&(this.cnt++,setTimeout((()=>this.nextOperation()),10))}close(){}nextOperation(){if(this.wait_for_file)return;const t=this.protocol[this.cnt];t&&"send"!==t&&(this.wait_for_file=!0,this.cnt++,(0,i.httpRequest)(t,t.indexOf(".bin")>0?"buf":"text").then((e=>{if(this.wait_for_file=!1,!e)return;const s=t.indexOf("_ch"),a=s>0?Number.parseInt(t.slice(s+3,t.indexOf(".",s))):1;(0,i.isFunc)(this.receiver.provideData)&&this.receiver.provideData(a,e,0),setTimeout((()=>this.nextOperation()),10)})))}}class M{constructor(t,e){this.kind=t,this.state=0,this.credits=e||10,this.cansend=this.credits,this.ackn=this.credits,this.send_seq=1,this.recv_seq=0}getUserArgs(t){return t&&(0,i.isStr)(t)?(0,i.isObject)(this.user_args)?this.user_args[t]:void 0:this.user_args}setUserArgs(t){this.user_args=t}setReceiver(t){this.receiver=t}cleanup(){delete this.receiver,this.close(!0)}invokeReceiver(t,e,s,a){if(this.receiver&&(0,i.isFunc)(this.receiver[e])&&this.receiver[e](this,s,a),t&&this.channels){const t=Object.keys(this.channels);for(let i=0;i<t.length;++i)this.channels[t[i]].invokeReceiver(!1,e,s,a)}}provideData(t,e,s){if(this.wait_first_recv)return delete this.wait_first_recv,this.state=1,this.invokeReceiver(!1,"onWebsocketOpened");if(t>1&&this.channels){const i=this.channels[t];if(i)return i.provideData(1,e,s)}const i=s&&s<0;if(!i&&(!this.msgqueue||!this.msgqueue.length))return this.invokeReceiver(!1,"onWebsocketMsg",e,s);this.msgqueue||(this.msgqueue=[]),i&&(s=void 0),this.msgqueue.push({ready:!0,msg:e,len:s})}reserveQueueItem(){this.msgqueue||(this.msgqueue=[]);const t={ready:!1,msg:null,len:0};return this.msgqueue.push(t),t}markQueueItemDone(t,e,s){t.ready=!0,t.msg=e,t.len=s,this.processQueue()}processQueue(){if(!this._loop_msgqueue&&this.msgqueue){for(this._loop_msgqueue=!0;this.msgqueue.length>0&&this.msgqueue[0].ready;){const t=this.msgqueue.shift();this.invokeReceiver(!1,"onWebsocketMsg",t.msg,t.len)}0===this.msgqueue.length&&delete this.msgqueue,delete this._loop_msgqueue}}close(t){if(this.master)return this.master.send(`CLOSECH=${this.channelid}`,0),delete this.master.channels[this.channelid],void delete this.master;this.timerid&&(clearTimeout(this.timerid),delete this.timerid),this._websocket&&this.state>0&&(this.state=t?-1:0,this._websocket.onclose=null,this._websocket.close(),delete this._websocket)}canSend(t){return this.cansend>=(t||1)}getRelCanSend(){return this.credits?this.cansend/this.credits:1}send(t,e){if(this.master)return this.master.send(t,this.channelid);if(!this._websocket||this.state<=0)return!1;Number.isInteger(e)||(e=1),this.cansend<=0&&console.error(`should be queued before sending cansend: ${this.cansend}`);const s=`${this.send_seq++}:${this.ackn}:${this.cansend}:${e}:`;this.ackn=0,this.cansend--;let i="none";return this.key&&z&&(i=C(this.key,`${s}${t}`)),this._websocket.send(`${i}:${s}${t}`),"websocket"!==this.kind&&"longpoll"!==this.kind||(this.timerid&&clearTimeout(this.timerid),this.timerid=setTimeout((()=>this.keepAlive()),1e4)),!0}sendLast(t,e,s){let i=this._delayed;i||(i=this._delayed={}),i[t]=s,i[`${t}_handler`]||(i[`${t}_handler`]=setTimeout((()=>{delete i[`${t}_handler`],this.send(i[t])}),e))}inject(t,e,s){if(!s)return setTimeout(this.inject.bind(this,t,e,!0),0);if(void 0===e&&(e=1),Array.isArray(t)){for(let s=0;s<t.length;++s)this.provideData(e,(0,i.isStr)(t[s])?t[s]:JSON.stringify(t[s]),-1);this.processQueue()}else t&&this.provideData(e,(0,i.isStr)(t)?t:JSON.stringify(t))}keepAlive(){delete this.timerid,this.send("KEEPALIVE",0)}resizeWindow(t,e){i.browser.qt5||i.browser.cef3?this.send(`RESIZE=${t},${e}`,0):"undefined"!==typeof window&&(0,i.isFunc)(window?.resizeTo)&&window.resizeTo(t,e)}createChannel(){if(this.master)return this.master.createChannel();const t=new M("channel",this.credits);return t.wait_first_recv=!0,this.channels||(this.channels={},this.freechannelid=2),t.master=this,t.channelid=this.freechannelid++,this.channels[t.channelid]=t,t}isConnected(){return this.state>0}getChannelId(){return this.channelid&&this.master?this.channelid:1}setHRef(t){if((0,i.isStr)(t)&&t.indexOf("?")>0){this.href=t.slice(0,t.indexOf("?"));const e=(0,i.decodeUrl)(t);this.key=e.get("key"),this.token=e.get("token")}else this.href=t,delete this.key,delete this.token}getHRef(t){if(!t||!this.kind||!this.href)return this.href;let e=this.href;if(0===t.indexOf("../")){const s=e.lastIndexOf("/",e.length-2);e=e.slice(0,s)+t.slice(2)}else e+=t;return e}getConnArgs(t){let e="";if(this.key){e+=`key=${C(this.key,`attempt_${t}`)}&ntry=${t}`}return this.token&&(e&&(e+="&"),e+=`token=${this.token}`),e}connect(t){this.close(),!t&&this.href&&(t=this.href);let e=0;const s=a=>{if(0!==this.state)return;a||console.log(`try connect window again ${(new Date).toString()}`),this._websocket&&(this._websocket.close(),delete this._websocket),t||((t=window.location.href)&&t.indexOf("#")>0&&(t=t.slice(0,t.indexOf("#"))),t&&t.lastIndexOf("/")>0&&(t=t.slice(0,t.lastIndexOf("/")+1))),this.href=t,e++,a&&console.log(`Opening web socket at ${t}`),e>2&&(0,n.Rh)(`Trying to connect ${t}`);let h=t;"file"===this.kind?(h+="root.filedump",this._websocket=new A(this),console.log(`configure protocol log ${h}`)):"websocket"===this.kind&&a?(h=h.replace("http://","ws://").replace("https://","wss://")+"root.websocket",h+="?"+this.getConnArgs(e),console.log(`configure websocket ${h}`),this._websocket=new WebSocket(h)):(h+="root.longpoll",console.log(`configure longpoll ${h}`),this._websocket=new S(h,"rawlongpoll"===this.kind,this,e)),this._websocket&&(this._websocket.onopen=()=>{e>2&&(0,n.Rh)(),this.state=1;const t=this.key||"";this.send(`READY=${t}`,0),this.invokeReceiver(!1,"onWebsocketOpened")},this._websocket.onmessage=t=>{let e=t.data;if(this.next_binary){const s=this.next_binary,i=this.next_binary_hash;if(delete this.next_binary,delete this.next_binary_hash,e instanceof Blob){const s=new FileReader,a=this.reserveQueueItem();s.onload=t=>{let e=t.target.result;if(this.key&&z){C(this.key,e,0)!==i&&(console.log("Discard binary buffer because of HMAC mismatch"),e=new ArrayBuffer(0))}this.markQueueItemDone(a,e,0)},s.readAsArrayBuffer(e,t.offset||0)}else{let a=e;if(this.key&&z){C(this.key,a,t.offset||0)!==i&&(console.log("Discard binary buffer because of HMAC mismatch"),a=new ArrayBuffer(0))}this.provideData(s,a,t.offset||0)}return}if(!(0,i.isStr)(e))return console.log("unsupported message kind: "+typeof e);const s=e.indexOf(":"),a=e.slice(0,s),n=e.indexOf(":",s+1),h=Number.parseInt(e.slice(s+1,n)),r=e.indexOf(":",n+1),o=Number.parseInt(e.slice(n+1,r)),l=e.indexOf(":",r+1),d=e.indexOf(":",l+1),c=Number.parseInt(e.slice(l+1,d));if(this.key&&z){if(a!==C(this.key,e.slice(s+1)))return console.log(`Failure checking server md5 sum ${a}`)}if(h<=this.recv_seq)return console.log(`Failure with packet sequence ${h} <= ${this.recv_seq}`);if(this.recv_seq=h,this.ackn++,this.cansend+=o,e=e.slice(d+1),0===c){if(console.log(`GET chid=0 message ${e}`),"CLOSE"===e)this.close(!0),this.invokeReceiver(!0,"onWebsocketClosed");else if(0===e.indexOf("NEW_KEY=")){const t=e.slice(8);this.close(!0);let s="undefined"!==typeof document?document.URL:null;if((0,i.isStr)(s)&&"undefined"!==typeof window&&window?.history){const e=s.indexOf("?key=");e>0&&(s=s.slice(0,e)),window.history.replaceState(window.history.state,void 0,`${s}?key=${t}`)}else"undefined"!==typeof sessionStorage&&sessionStorage.setItem("RWebWindow_Key",t);location.reload(!0)}}else"$$binary$$"===e.slice(0,10)?(this.next_binary=c,this.next_binary_hash=e.slice(10)):"$$nullbinary$$"===e?this.provideData(c,new ArrayBuffer(0),0):this.provideData(c,e);this.ackn>7&&this.send("READY",0)},this._websocket.onclose=t=>{delete this._websocket,(this.state>0||"force_close"===t)&&(console.log("websocket closed"),this.state=0,this.invokeReceiver(!0,"onWebsocketClosed"))},this._websocket.onerror=t=>{console.log(`websocket error ${t} state ${this.state}`),this.state>0&&(this.invokeReceiver(!0,"onWebsocketError",t),this.state=0)},(0,i.isBatchMode)()||setTimeout(s,3e3))};s(!0)}askReload(){this.send("GENERATE_KEY",0)}addReloadKeyHandler(){"file"!==this.kind&&window.addEventListener("keydown",(t=>{"R"!==t.key&&"r"!==t.key||!t.ctrlKey||(t.stopPropagation(),t.preventDefault(),console.log("Prevent Ctrl-R propogation - ask reload RWebWindow!"),this.askReload())}))}}class R extends x{constructor(t,e){super(t,e,!0),this._websocket=null,this.tooltip_allowed=i.settings.Tooltip,this.v7canvas=!0,null===t&&null===e&&(i.settings.SmallPad.width=20,i.settings.SmallPad.height=10)}cleanup(){delete this._websocket,delete this._submreq,this._changed_layout&&this.setLayoutKind("simple"),delete this._changed_layout,super.cleanup()}getLayoutKind(){const t=this.selectDom("origin");return(t.empty()?"":t.property("layout"))||"simple"}setLayoutKind(t,e){const s=this.selectDom("origin");s.empty()||(t||(t="simple"),s.property("layout",t),s.property("layout_selector","simple"!==t&&e?e:null),this._changed_layout="simple"!==t)}async changeLayout(t,e){if(this.getLayoutKind()===t)return!0;const s=this.selectDom("origin"),i=s.select(".side_panel2"),n=[];let r,l=s.select(".side_panel"),d=this.selectDom();for(;d.node().firstChild;)n.push(d.node().removeChild(d.node().firstChild));if(l.empty()||(0,o.tP)(l.node()),i.empty()||(0,o.tP)(i.node()),this.setLayoutKind("simple"),s.html(""),"simple"===t){d=s;for(let t=0;t<n.length;++t)d.node().appendChild(n[t]);this.setLayoutKind(t),r=!0}else{const i=new h.ho(s.node(),t);void 0===e&&(e=0===t.indexOf("vert")?0:1),d=(0,a.Lt)(i.getGridFrame(e)),d.classed("central_panel",!0).style("position","relative"),2===e?(l=(0,a.Lt)(i.getGridFrame(0)),l.classed("side_panel2",!0).style("position","relative"),l=(0,a.Lt)(i.getGridFrame(3)),l.classed("side_panel",!0).style("position","relative")):(l=(0,a.Lt)(i.getGridFrame(1-e)),l.classed("side_panel",!0).style("position","relative"));for(let t=0;t<n.length;++t)d.node().appendChild(n[t]);this.setLayoutKind(t,".central_panel"),s.property("mdi",null)}return(0,o.XR)(d.node(),r),!0}async toggleProjection(t){if(delete this.proj_painter,t&&(this.proj_painter={X:!1,Y:!1}),(0,i.isFunc)(this.showUI5ProjectionArea))return this.showUI5ProjectionArea(t);let e,s="simple";switch(t){case"XY":s="projxy",e=2;break;case"X":case"bottom":s="vert2_31",e=0;break;case"Y":case"left":s="horiz2_13",e=1;break;case"top":s="vert2_13",e=1;break;case"right":s="horiz2_31",e=0}return this.changeLayout(s,e)}async drawProjection(){return!1}async drawInSidePanel(t,e,s){const i="projxy"===this.getLayoutKind()&&"Y"===s?".side_panel2":".side_panel",a=this.selectDom("origin").select(i);return a.empty()?null:this.drawObject(a.node(),t,e)}testUI5(){return!!this.use_openui&&(console.warn("full ui5 should be used - not loaded yet? Please check!!"),!0)}showMessage(t){this.testUI5()||(0,n.Rh)(t,7e3)}saveCanvasAsFile(t){const e=t.indexOf(".");this.createImage(t.slice(e+1)).then((e=>this.sendWebsocket(`SAVE:${t}:${e}`)))}sendSaveCommand(t){this.sendWebsocket("PRODUCE:"+t)}sendWebsocket(t){return!!this._websocket?.canSend()&&(this._websocket.send(t),!0)}closeWebsocket(t){this._websocket&&(this._websocket.close(t),this._websocket.cleanup(),delete this._websocket)}useWebsocket(t){this.closeWebsocket(),this._websocket=t,this._websocket.setReceiver(this),this._websocket.connect()}websocketTimeout(t,e){if(!this._websocket)return;this._websocket._tmouts||(this._websocket._tmouts={});const s=this._websocket._tmouts[t];if(void 0===e)return void 0!==s;"reset"===e?s&&(clearTimeout(s),delete this._websocket._tmouts[t]):!s&&Number.isInteger(e)&&(this._websocket._tmouts[t]=setTimeout((()=>{delete this._websocket._tmouts[t]}),e))}onWebsocketOpened(){}onWebsocketClosed(){this.embed_canvas||(0,n.W4)()}onWebsocketMsg(t,e){if("CLOSE"===e)this.onWebsocketClosed(),this.closeWebsocket(!0);else if("SNAP:"===e.slice(0,5)){const s=(e=e.slice(5)).indexOf(":"),a=e.slice(0,s),n=(0,i.parse)(e.slice(s+1));this.syncDraw(!0).then((()=>{!this.snapid&&n?.fWinSize&&this.resizeBrowser(n.fWinSize[0],n.fWinSize[1])})).then((()=>this.redrawPadSnap(n))).then((()=>{this.addPadInteractive(),t.send(`SNAPDONE:${a}`),this.confirmDraw()}))}else if("JSON"===e.slice(0,4)){const t=(0,i.parse)(e.slice(4));this.redrawObject(t)}else if("REPL_REQ:"===e.slice(0,9))this.processDrawableReply(e.slice(9));else if("CMD:"===e.slice(0,4)){const s=(e=e.slice(4)).indexOf(":"),a=e.slice(0,s),n=e.slice(s+1),h=`REPLY:${a}:`;if("SVG"===n||"PNG"===n||"JPEG"===n)this.createImage(n.toLowerCase()).then((e=>t.send(h+e)));else if(0===n.indexOf("ADDPANEL:")){const e=n.slice(9);if((0,i.isFunc)(this.showUI5Panel)){const s=new M(t.kind);s.setReceiver({cpainter:this,onWebsocketOpened(){},onWebsocketMsg(e,s){const i=0===s.indexOf("SHOWPANEL:")?s.slice(10):"";this.cpainter.showUI5Panel(i,e).then((e=>t.send(h+(e?"true":"false"))))},onWebsocketClosed(){t.send(h+"false")},onWebsocketError(){t.send(h+"false")}});let i=t.href;if(0===e.indexOf("../")){const t=i.lastIndexOf("/",i.length-2);i=i.slice(0,t)+e.slice(2)}else i+=e;s.connect(i)}else t.send(h+"false")}else console.log("Unrecognized command "+n),t.send(h)}else if("DXPROJ:"===e.slice(0,7)||"DYPROJ:"===e.slice(0,7)){const t=e[1],s=(0,i.parse)(e.slice(7));this.drawProjection(t,s)}else if("SHOW:"===e.slice(0,5)){const t=e.slice(5),s="1"===t[t.length-1];this.showSection(t.slice(0,t.length-2),s)}else console.log(`unrecognized msg len: ${e.length} msg: ${e.slice(0,30)}`)}submitDrawableRequest(t,e,s,a){if(!this._websocket||!e||!e._typename||!s.snapid||!(0,i.isStr)(s.snapid))return null;if(t&&a){s._requests||(s._requests={});const i=s._requests[t];if(i){const a=(new Date).getTime();if(!i._tm||a-i._tm<5e3)return i._nextreq=e,!1;delete s._requests[t]}s._requests[t]=e}e.id=s.snapid,a?(this._nextreqid||(this._nextreqid=1),e.reqid=this._nextreqid++):e.reqid=0;const n=JSON.stringify(e);return e.reqid&&(e._kind=t,e._painter=s,e._method=a,e._tm=(new Date).getTime(),this._submreq||(this._submreq={}),this._submreq[e.reqid]=e),this.sendWebsocket("REQ:"+n),e}async submitMenuRequest(t,e,s){return new Promise((a=>{this.submitDrawableRequest("",{_typename:`${i.nsREX}RDrawableMenuRequest`,menukind:e||"",menureqid:s},t,a)}))}submitExec(t,e,s){if(this._websocket){if(s&&(0,i.isStr)(s)){const t=s.length;if(t>2&&s.indexOf("#x")===t-2?s="x":t>2&&s.indexOf("#y")===t-2?s="y":t>2&&s.indexOf("#z")===t-2&&(s="z"),"x"!==s&&"y"!==s&&"z"!==s)return console.log(`not recoginzed subelem ${s} in SubmitExec`);e=s+"axis#"+e}this.submitDrawableRequest("",{_typename:`${i.nsREX}RDrawableExecRequest`,exec:e},t)}}processDrawableReply(t){const e=(0,i.parse)(t);if(!e||!e.reqid||!this._submreq)return!1;const s=this._submreq[e.reqid];if(!s)return!1;delete this._submreq[e.reqid],s._kind&&s._painter?._requests&&s._painter._requests[s._kind]===s&&delete s._painter._requests[s._kind],s._method&&s._method(e,s),s._nextreq&&!s._painter._requests[s._kind]&&this.submitDrawableRequest(s._kind,s._nextreq,s._painter,s._method)}async showSection(t,e){switch(t){case"Menu":case"StatusBar":case"Editor":case"ToolBar":break;case"ToolTips":this.setTooltipAllowed(e)}return!0}processChanges(t,e,s){if(!this._websocket||!this._websocket.canSend(2)||!(0,i.isStr)(t))return;switch(e||(e=this),t){case"sbits":console.log("Status bits in RCanvas are changed - that to do?");break;case"frame":case"zoom":console.log("Frame moved or zoom is changed - that to do?");break;case"pave_moved":console.log("TPave is moved inside RCanvas - that to do?");break;default:"exec:"===t.slice(0,5)&&e?.snapid?this.submitExec(e,t.slice(5),s):console.log("UNPROCESSED CHANGES",t)}}clickPadButton(t,e){return"ToggleGed"===t?this.activateGed(this,null,"toggle"):"ToggleStatus"===t?this.activateStatusBar("toggle"):super.clickPadButton(t,e)}hasEventStatus(){if(this.testUI5())return!1;if(this.brlayout)return this.brlayout.hasStatus();const t=(0,h.gZ)();return!!t&&t.hasStatusLine()}canStatusBar(){return this.testUI5()||this.brlayout||(0,h.gZ)()}activateStatusBar(t){this.testUI5()||(this.brlayout?this.brlayout.createStatusLine(23,t):(0,h.gZ)()?.createStatusLine(23,t),this.processChanges("sbits",this))}showCanvasStatus(){if(this.testUI5())return;const t=this.brlayout||(0,h.gZ)()?.brlayout;for(var e=arguments.length,s=new Array(e),i=0;i<e;i++)s[i]=arguments[i];t?.showStatus(...s)}hasGed(){return!this.testUI5()&&(this.brlayout?.hasContent()??!1)}removeGed(){this.testUI5()||(this.registerForPadEvents(null),this.ged_view&&(this.ged_view.getController().cleanupGed(),this.ged_view.destroy(),delete this.ged_view),this.brlayout?.deleteContent(!0),this.processChanges("sbits",this))}getUi5PanelData(){return{jsroot:{settings:i.settings,create:i.create,parse:i.parse,toJSON:i.toJSON,loadScript:i.loadScript,EAxisBits:o.rb,getColorExec:n.pp}}}async activateGed(t,e,s){if(this.testUI5()||!this.brlayout)return!1;if(this.brlayout.hasContent())return"toggle"===s||!1===s?this.removeGed():t?.getPadPainter()?.selectObjectPainter(t),!0;if(!1===s)return!1;const i=this.brlayout.createBrowserBtns();return n.IK.createSVG(i,n.IK.diamand,15,"toggle fix-pos mode","browser").style("margin","3px").on("click",(()=>this.brlayout.toggleKind("fix"))),n.IK.createSVG(i,n.IK.circle,15,"toggle float mode","browser").style("margin","3px").on("click",(()=>this.brlayout.toggleKind("float"))),n.IK.createSVG(i,n.IK.cross,15,"delete GED","browser").style("margin","3px").on("click",(()=>this.removeGed())),this.brlayout.setBrowserContent("<div class='jsroot_browser_hierarchy' id='ged_placeholder'>Loading GED ...</div>"),this.brlayout.setBrowserTitle("GED"),this.brlayout.toggleBrowserKind(e||"float"),new Promise((e=>{n.cA.then((s=>{(0,a.Lt)("#ged_placeholder").text(""),s.ui.require(["sap/ui/model/json/JSONModel","sap/ui/core/mvc/XMLView"],((s,i)=>{const a=new s({handle:null});i.create({viewName:"rootui5.canv.view.Ged",viewData:this.getUi5PanelData("Ged")}).then((s=>{s.setModel(a),s.placeAt("ged_placeholder"),this.ged_view=s,this.registerForPadEvents(s.getController().padEventsReceiver.bind(s.getController())),t?.getPadPainter()?.selectObjectPainter(t),this.processChanges("sbits",this),e(!0)}))}))}))}))}produceJSON(){return console.error("RCanvasPainter.produceJSON not yet implemented"),""}resizeBrowser(t,e){!t||!e||this.isBatchMode()||this.embed_canvas||this.batch_mode||this._websocket?.resizeWindow(t,e)}static async draw(t,e){const s=!e;s&&(e=(0,i.create)(`${i.nsREX}RCanvas`));const a=new R(t,e);return a.normal_canvas=!s,a.createCanvasSvg(0),(0,o.QD)({pp:a,active:!1}),a.drawPrimitives().then((()=>(a.addPadInteractive(),a.addPadButtons(),a.showPadButtons(),a)))}}function E(t,e){const s=new R(t,null);return s.normal_canvas=!1,s.batch_mode=(0,i.isBatchMode)(),s.syncDraw(!0).then((()=>s.redrawPadSnap(e))).then((()=>(s.confirmDraw(),s.showPadButtons(),s)))}async function O(t,e){if(!t)return Promise.reject(Error("Painter not provided in ensureRCanvas"));return(t.getCanvSvg().empty()?R.draw(t.getDom(),null):Promise.resolve(!0)).then((()=>{if(!1!==e&&t.getFrameSvg().selectChild(".main_layer").empty())return u.draw(t.getDom(),null,(0,i.isStr)(e)?e:"")})).then((()=>(t.addToPadPrimitives(),t)))}function F(t,e){const s=this.getFramePainter();if(!s)return console.log("no frame painter - no title");const i=s.getFrameRect(),a=i.x,n=i.y,h=i.width,o=this.getPadPainter().getPadHeight(),l=this.getObject(),d=h,c=this.v7EvalFont("text",{size:.07,color:"black",align:22});let g=this.v7EvalLength("margin",o,.02),u=this.v7EvalLength("height",o,.05);if("drag"===t){u=e.height,g=n-e.y-e.height;const t={};this.v7AttrChange(t,"margin",g/o),this.v7AttrChange(t,"height",u/o),this.v7SendAttrChanges(t,!1)}this.createG(),(0,r.bk)(this.draw_g,a,Math.round(n-g-u));const _={x:d/2,y:u/2,text:l.fText,latex:1};return this.startTextDrawing(c,"font"),this.drawText(_),this.finishTextDrawing().then((()=>(0,m.WJ)(this,{x:a,y:Math.round(n-g-u),width:d,height:u,minwidth:20,minheight:20,no_change_x:!0,redraw:t=>this.redraw("drag",t)})))}function D(){const t=this.getObject(),e=this.getCanvSvg(),s="custom_font_"+t.fFamily+t.fWeight+t.fStyle;let i=e.selectChild(".canvas_defs");i.empty()&&(i=e.insert("svg:defs",":first-child").attr("class","canvas_defs"));let a=i.selectChild("."+s);if(a.empty()){a=i.append("style").attr("type","text/css").attr("class",s).text(`@font-face { font-family: "${t.fFamily}"; font-weight: ${t.fWeight?t.fWeight:"normal"}; font-style: ${t.fStyle?t.fStyle:"normal"}; src: ${t.fSrc}; }`);const e=t.fSrc.indexOf("base64,"),n=t.fSrc.lastIndexOf(" format(");if(e>0&&n>e){const s=t.fSrc.slice(e+7,n-2);t.fSrc.indexOf("data:application/font-ttf")>0&&a.property("$fonthandler",{name:t.fFamily,format:"ttf",base64:s})}}return t.fDefault&&(this.getPadPainter()._dfltRFont=t),!0}function $(t,e,s){const i=new d.R(t,e,s);return i.disable_zooming=!0,O(i,!1).then((()=>i.redraw())).then((()=>i))}function T(t,e,s){const i=new u(t,e);return"3d"===s&&(i.mode3d=!0),O(i,!1).then((()=>i.redraw()))}(0,i.registerMethods)(`${i.nsREX}RPalette`,{extractRColor:t=>t.fColor||"black",getColor(t){return this.palette[t]},getContourIndex(t){const e=this.fContour;let s,i=0,a=e.length-1;if(t<e[0])return-1;if(t>=e[a])return a-1;if(this.fCustomContour){for(;i<a-1;)s=Math.round((i+a)/2),e[s]>t?a=s:i=s;return i}return Math.floor((t-e[0])/(e[a-1]-e[0])*(a-1))},getContourColor(t){const e=this.getContourIndex(t);return e<0?"":this.getColor(e)},getContour(){return this.fContour&&this.fContour.length>1?this.fContour:null},deleteContour(){delete this.fContour},calcColor(t,e,s){const i=s.fOrdinal-e.fOrdinal,n=s.fOrdinal-t,h=t-e.fOrdinal;if(!this.fInterpolate||i<=0)return n<h?s.fColor:e.fColor;const r=(0,a.Qh)(this.extractRColor(e.fColor)),o=(0,a.Qh)(this.extractRColor(s.fColor));return(0,a.Qh)(Math.round((r.r*n+o.r*h)/i),Math.round((r.g*n+o.g*h)/i),Math.round((r.b*n+o.b*h)/i)).toString()},createPaletteColors(t){const e=[];let s=0;for(;e.length<t;){const i=e.length/(t-1),a=this.fColors[s];if(Math.abs(a.fOrdinal-i)<1e-4||s===this.fColors.length-1){e.push(this.extractRColor(a.fColor));continue}const n=this.fColors[s+1];n.fOrdinal<=i?s++:e.push(this.calcColor(i,a,n))}return e},getColorOrdinal(t){if(!this.fColors)return"black";"number"!==typeof t||t<0?t=0:t>1&&(t=1);let e,s=this.fColors[0];for(let i=0;i<this.fColors.length-1;++i){if(e=s,Math.abs(e.fOrdinal-t)<1e-4)return this.extractRColor(e.fColor);if(s=this.fColors[i+1],s.fOrdinal>t)return this.calcColor(t,e,s)}return this.extractRColor(s.fColor)},setFullRange(t,e){this.full_min=t,this.full_max=e},createContour(t,e,s,i,a){if(this.fContour=[],delete this.fCustomContour,this.colzmin=s,this.colzmax=i,t){this.colzmax<=0&&(this.colzmax=1),this.colzmin<=0&&(this.colzmin=void 0===a||a<=0?1e-4*this.colzmax:a<3||a>100?.3*a:1),this.colzmin>=this.colzmax&&(this.colzmin=1e-4*this.colzmax);const t=Math.log(this.colzmin)/Math.log(10),s=(Math.log(this.colzmax)/Math.log(10)-t)/e;this.fContour.push(this.colzmin);for(let i=1;i<e;i++)this.fContour.push(Math.exp((t+s*i)*Math.log(10)));this.fContour.push(this.colzmax),this.fCustomContour=!0}else{this.colzmin===this.colzmax&&0!==this.colzmin&&(this.colzmax+=.01*Math.abs(this.colzmax),this.colzmin-=.01*Math.abs(this.colzmin));const t=(this.colzmax-this.colzmin)/e;for(let s=0;s<=e;s++)this.fContour.push(this.colzmin+t*s)}this.palette&&this.palette.length===e||(this.palette=this.createPaletteColors(e))}})}}]);
//# sourceMappingURL=4709.b065e866.chunk.js.map